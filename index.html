<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>n0t3.zt</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Lora:ital,wght@0,400;0,500;1,400&family=Nunito:ital,wght@0,300;0,400;1,300&family=Syne+Mono&family=Archivo:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #ffffff;
    --fg: #000000;
    --fg-dim: #888888;
    --fg-dimmer: #cccccc;
    --line: #e0e0e0;
    --ui-font: 'Fira Code', monospace;
    --editor-font: 'Fira Code', monospace;
    --font-size: 15px;
    --line-height: 1.8;
    --page-width: 65%;
  }

  .inverted {
    --bg: #0a0a0a;
    --fg: #e8e8e8;
    --fg-dim: #555555;
    --fg-dimmer: #2a2a2a;
    --line: #1e1e1e;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 16px;
    transition: background 0.2s, color 0.2s;
    overflow: hidden;
  }

  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* ══ TOPBAR ══ */
  #topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 20px;
    border-bottom: 1px solid var(--line);
    flex-shrink: 0;
    gap: 10px;
    flex-wrap: wrap;
  }

  #topbar-left  { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  #topbar-right { display: flex; align-items: center; gap: 7px;  flex-wrap: wrap; }

  .logo {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 0.08em;
    color: var(--fg);
  }

  .sep { color: var(--fg-dimmer); font-size: 13px; user-select: none; }

  /* ══ BUTTONS ══ */
  .btn {
    background: none;
    border: 1px solid var(--line);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 12px;
    letter-spacing: 0.07em;
    padding: 4px 10px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    white-space: nowrap;
  }
  .btn:hover  { border-color: var(--fg); }
  .btn.active { background: var(--fg); color: var(--bg); }
  .btn:disabled { opacity: 0.28; cursor: not-allowed; }

  .btn-ghost {
    background: none; border: none;
    color: var(--fg-dim);
    font-family: var(--ui-font);
    font-size: 13px;
    cursor: pointer; padding: 4px 6px;
    transition: color 0.15s;
  }
  .btn-ghost:hover { color: var(--fg); }

  /* ══ WIDTH CONTROL ══ */
  #width-control { display: flex; align-items: center; gap: 7px; }
  #width-slider {
    -webkit-appearance: none; appearance: none;
    width: 80px; height: 2px;
    background: var(--line); outline: none; cursor: pointer;
  }
  #width-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 10px; height: 10px;
    background: var(--fg); border-radius: 50%; cursor: pointer;
  }
  #width-label { font-size: 12px; color: var(--fg-dim); min-width: 34px; }

  /* ══ EDITOR ══ */
  #editor-wrap {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 52px 0;
    display: flex;
    justify-content: center;
  }

  #page { width: var(--page-width); min-width: 0; }

  #editor {
    width: 100%;
    min-height: 60vh;
    background: transparent;
    border: none; outline: none;
    color: var(--fg);
    font-family: var(--editor-font);
    font-size: var(--font-size);
    font-weight: 300;
    line-height: var(--line-height);
    resize: none;
    caret-color: var(--fg);
    white-space: pre-wrap;
    word-break: break-word;
    overflow-wrap: break-word;
    -webkit-font-smoothing: antialiased;
  }
  #editor::placeholder { color: var(--fg-dimmer); font-style: italic; }
  #editor:disabled     { opacity: 0.3; cursor: not-allowed; }

  /* ══ TIMER OVERLAY ══ */
  #timer-overlay {
    display: none;
    position: fixed;
    top: 52px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 80;
    text-align: center;
    pointer-events: none;
    user-select: none;
  }
  #timer-overlay.visible { display: block; }

  #timer-big {
    font-size: 72px;
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--fg);
    opacity: 0.07;
    transition: opacity 0.3s, color 0.3s, font-size 0.3s;
  }
  #timer-overlay.warning #timer-big {
    opacity: 0.18;
    color: #cc3333;
  }
  #timer-overlay.expired #timer-big {
    opacity: 0.35;
    color: #cc3333;
  }
  #timer-label {
    font-size: 12px;
    letter-spacing: 0.15em;
    color: var(--fg-dim);
    opacity: 0.5;
    margin-top: 4px;
  }

  /* ══ SPRINT BAR ══ */
  #sprint-bar-wrap {
    display: none;
    height: 2px;
    background: var(--line);
    flex-shrink: 0;
    position: relative;
  }
  #sprint-bar {
    height: 100%;
    background: var(--fg);
    width: 0%;
    transition: width 0.6s;
  }

  /* ══ STATUSBAR ══ */
  #statusbar {
    border-top: 1px solid var(--line);
    padding: 8px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  #counters { display: flex; gap: 18px; flex-wrap: wrap; align-items: center; }

  #selection-badge {
    font-size: 12px;
    color: var(--bg);
    background: var(--fg);
    padding: 2px 8px;
    letter-spacing: 0.06em;
    display: none;
    white-space: nowrap;
  }
  #selection-badge.visible { display: inline; }

  .stat {
    font-size: 12px;
    color: var(--fg-dim);
    letter-spacing: 0.03em;
    white-space: nowrap;
  }
  .stat strong { color: var(--fg); font-weight: 500; }

  #status-right { display: flex; align-items: center; gap: 12px; }

  #session-clock {
    font-size: 13px;
    letter-spacing: 0.1em;
    color: var(--fg-dim);
    display: none;
  }
  #session-clock.active { display: inline; color: var(--fg); }

  /* ══ MODALS ══ */
  .modal-wrap {
    display: none;
    position: fixed; inset: 0; z-index: 100;
    align-items: center; justify-content: center;
  }
  .modal-wrap.open { display: flex; }

  .modal-backdrop {
    position: absolute; inset: 0;
    background: var(--bg); opacity: 0.88;
  }
  .modal-box {
    position: relative;
    background: var(--bg);
    border: 1px solid var(--fg);
    padding: 30px 34px;
    width: 400px; max-width: 92vw;
    font-family: var(--ui-font);
    z-index: 1;
  }
  .modal-title {
    font-size: 12px; letter-spacing: 0.2em;
    font-weight: 500; margin-bottom: 22px;
  }
  .modal-row { margin-bottom: 14px; }
  .modal-label {
    font-size: 12px; color: var(--fg-dim);
    letter-spacing: 0.08em; margin-bottom: 5px;
  }
  .modal-input {
    width: 100%; background: none;
    border: 1px solid var(--line);
    color: var(--fg); font-family: var(--ui-font);
    font-size: 14px; padding: 7px 10px;
    outline: none; transition: border-color 0.15s;
  }
  .modal-input:focus { border-color: var(--fg); }
  .modal-input[type="file"] { padding: 5px; }
  .modal-actions {
    display: flex; gap: 8px;
    margin-top: 22px; justify-content: flex-end;
  }
  .modal-close-x {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none;
    color: var(--fg-dim); font-size: 18px;
    cursor: pointer; font-family: var(--ui-font); line-height: 1;
  }

  /* ══ STATS OVERLAY ══ */
  #stats-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 150;
    align-items: center; justify-content: center;
    background: var(--bg); font-family: var(--ui-font);
  }
  #stats-overlay.open { display: flex; }
  .stats-box {
    border: 1px solid var(--fg);
    padding: 36px 44px;
    max-width: 440px; width: 92%;
  }
  .stats-title {
    font-size: 12px; letter-spacing: 0.2em;
    font-weight: 500; margin-bottom: 26px;
  }
  .stats-row {
    display: flex; justify-content: space-between;
    font-size: 13px; margin-bottom: 10px; color: var(--fg-dim);
  }
  .stats-row strong { color: var(--fg); font-weight: 500; }
  .stats-actions { margin-top: 28px; display: flex; gap: 10px; flex-wrap: wrap; }

  /* ══ HASH BLOCK ══ */
  .hash-block {
    margin-top: 18px;
    border-top: 1px solid var(--line);
    padding-top: 14px;
  }
  .hash-label { font-size: 9px; letter-spacing: 0.12em; color: var(--fg-dim); margin-bottom: 6px; }
  .hash-val {
    font-size: 9px; color: var(--fg);
    word-break: break-all; line-height: 1.6; opacity: 0.7;
  }
  .hash-ts { font-size: 9px; color: var(--fg-dim); margin-top: 4px; }

  /* ══ NOTIFICATION ══ */
  #notif {
    position: fixed; bottom: 52px; left: 50%;
    transform: translateX(-50%);
    background: var(--fg); color: var(--bg);
    font-family: var(--ui-font); font-size: 12px;
    letter-spacing: 0.1em; padding: 8px 18px;
    z-index: 200; opacity: 0; pointer-events: none;
    transition: opacity 0.22s; white-space: nowrap;
  }
  #notif.show { opacity: 1; }

  /* ══ KEYS PANEL ══ */
  #keys-panel {
    position: fixed; right: 0; top: 0; bottom: 0;
    width: 270px; background: var(--bg);
    border-left: 1px solid var(--line);
    padding: 24px 22px; z-index: 90;
    overflow-y: auto; font-family: var(--ui-font);
    transform: translateX(100%);
    transition: transform 0.22s;
  }
  #keys-panel.open { transform: translateX(0); }
  .keys-title { font-size: 12px; letter-spacing: 0.15em; font-weight: 500; margin-bottom: 20px; }
  .key-row {
    display: flex; justify-content: space-between;
    margin-bottom: 9px; font-size: 12px; color: var(--fg-dim);
    gap: 10px;
  }
  .key-row kbd { color: var(--fg); font-family: var(--ui-font); font-size: 12px; white-space: nowrap; }

  /* ══ POMODORO BAR ══ */
  #pomo-bar-wrap {
    display: none;
    flex-shrink: 0;
    border-bottom: 1px solid var(--line);
    padding: 6px 20px;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
  }
  #pomo-bar-wrap.visible { display: flex; }

  #pomo-phase {
    font-size: 12px;
    letter-spacing: 0.12em;
    font-weight: 500;
    min-width: 120px;
    white-space: nowrap;
  }
  #pomo-phase.work  { color: var(--fg); }
  #pomo-phase.break { color: var(--fg-dim); }

  #pomo-clock {
    font-size: 13px;
    letter-spacing: 0.1em;
    font-weight: 500;
    min-width: 56px;
  }

  #pomo-dots {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .pomo-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    border: 1px solid var(--fg-dim);
    transition: background 0.3s;
  }
  .pomo-dot.done  { background: var(--fg); border-color: var(--fg); }
  .pomo-dot.active { background: none; border-color: var(--fg); box-shadow: 0 0 0 2px var(--fg); }

  #pomo-track {
    flex: 1;
    height: 2px;
    background: var(--line);
    min-width: 80px;
    max-width: 200px;
    position: relative;
  }
  #pomo-track-fill {
    height: 100%;
    background: var(--fg);
    width: 0%;
    transition: width 1s linear;
  }

  #pomo-controls { display: flex; gap: 6px; margin-left: auto; }

  /* ══ TYPEWRITER MODE ══ */
  body.typewriter #editor-wrap { align-items: flex-start; }

  /* ══ SCROLLBAR ══ */
  #editor-wrap::-webkit-scrollbar { width: 3px; }
  #editor-wrap::-webkit-scrollbar-thumb { background: var(--fg-dimmer); }
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar">
    <div id="topbar-left">
      <span class="logo">n0t3.zt</span>
      <span class="sep">·</span>
      <div id="width-control">
        <input type="range" id="width-slider" min="30" max="95" value="65">
        <span id="width-label">65%</span>
      </div>
      <span class="sep">·</span>
      <button class="btn" id="btn-invert">INVERTIR</button>
      <span class="sep">·</span>
      <select id="font-select" class="btn" style="padding:4px 6px; cursor:pointer;">
        <option value="fira">Fira Code</option>
        <option value="lora">Lora</option>
        <option value="nunito">Nunito</option>
        <option value="syne">Syne Mono</option>
        <option value="archivo">Archivo</option>
      </select>
    </div>
    <div id="topbar-right">
      <button class="btn" id="btn-sprint">SPRINT</button>
      <button class="btn" id="btn-timer">TIMER</button>
      <button class="btn" id="btn-session">SESIÓN</button>
      <button class="btn" id="btn-pomo">POMODORO</button>
      <span class="sep">·</span>
      <button class="btn" id="btn-export">EXPORTAR .TXT</button>
      <button class="btn" id="btn-export-enc">EXPORTAR ENC</button>
      <button class="btn" id="btn-import">IMPORTAR</button>
      <span class="sep">·</span>
      <button class="btn" id="btn-clear" style="border-color:#cc3333; color:#cc3333;">BORRAR TODO</button>
      <button class="btn-ghost" id="btn-keys">?</button>
    </div>
  </div>

  <!-- SPRINT PROGRESS BAR -->
  <div id="sprint-bar-wrap"><div id="sprint-bar"></div></div>

  <!-- POMODORO BAR -->
  <div id="pomo-bar-wrap">
    <span id="pomo-phase" class="work">TRABAJO</span>
    <span id="pomo-clock">25:00</span>
    <div id="pomo-dots"></div>
    <div id="pomo-track"><div id="pomo-track-fill"></div></div>
    <div id="pomo-controls">
      <button class="btn" id="pomo-pause-btn">PAUSAR</button>
      <button class="btn" id="pomo-skip-btn">SALTAR</button>
      <button class="btn" id="pomo-stop-btn">DETENER</button>
    </div>
  </div>

  <!-- TIMER OVERLAY (watermark behind text) -->
  <div id="timer-overlay">
    <div id="timer-big">00:00</div>
    <div id="timer-label">TIMER ACTIVO</div>
  </div>

  <!-- EDITOR -->
  <div id="editor-wrap">
    <div id="page">
      <textarea id="editor" placeholder="empieza a escribir…" spellcheck="false"
        autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div id="statusbar">
    <div id="counters">
      <span id="selection-badge">SELECCIÓN</span>
      <div class="stat">Palabras <strong id="cnt-words">0</strong></div>
      <div class="stat">Caracteres <strong id="cnt-chars">0</strong></div>
      <div class="stat">Sin espacios <strong id="cnt-chars-ns">0</strong></div>
      <div class="stat">Líneas <strong id="cnt-lines">1</strong></div>
      <div class="stat">Párrafos <strong id="cnt-paragraphs">0</strong></div>
      <div class="stat">Bytes <strong id="cnt-bytes">0</strong></div>
      <div class="stat">Lectura <strong id="cnt-readtime">0 min</strong></div>
      <div class="stat">Vel. escritura <strong id="cnt-wpm">— wpm</strong></div>
    </div>
    <div id="status-right">
      <span id="session-clock">00:00:00</span>
    </div>
  </div>
</div>

<!-- NOTIFICATION -->
<div id="notif"></div>

<!-- STATS OVERLAY -->
<div id="stats-overlay">
  <div class="stats-box">
    <div class="stats-title">RESUMEN DE SESIÓN</div>
    <div class="stats-row">Tiempo total         <strong id="s-time">—</strong></div>
    <div class="stats-row">Palabras escritas     <strong id="s-words">—</strong></div>
    <div class="stats-row">Caracteres            <strong id="s-chars">—</strong></div>
    <div class="stats-row">Bytes                 <strong id="s-bytes">—</strong></div>
    <div class="stats-row">Líneas                <strong id="s-lines">—</strong></div>
    <div class="stats-row">Vel. promedio         <strong id="s-wpm-avg">—</strong></div>
    <div class="stats-row">Vel. pico             <strong id="s-wpm-peak">—</strong></div>
    <div class="stats-row">Inicio                <strong id="s-start">—</strong></div>
    <div class="stats-row">Fin                   <strong id="s-end">—</strong></div>
    <div class="stats-actions">
      <button class="btn" id="stats-export">EXPORTAR RESUMEN</button>
      <button class="btn" id="stats-close">CERRAR</button>
    </div>
  </div>
</div>

<!-- KEYS PANEL -->
<div id="keys-panel">
  <div class="keys-title">ATAJOS</div>
  <div class="key-row"><span>Invertir colores</span>        <kbd>Ctrl+I</kbd></div>
  <div class="key-row"><span>Modo máquina de escribir</span><kbd>Ctrl+T</kbd></div>
  <div class="key-row"><span>Copiar todo</span>             <kbd>Ctrl+Shift+C</kbd></div>
  <div class="key-row"><span>Exportar .txt</span>           <kbd>Ctrl+S</kbd></div>
  <div class="key-row"><span>Borrar todo</span>             <kbd>Ctrl+Shift+X</kbd></div>
  <div class="key-row"><span>Timer</span>                   <kbd>Ctrl+Shift+T</kbd></div>
  <div class="key-row"><span>Sprint</span>                  <kbd>Ctrl+Shift+P</kbd></div>
  <div class="key-row"><span>Pomodoro</span>                <kbd>Ctrl+Shift+O</kbd></div>
  <div class="key-row"><span>Sesión</span>                  <kbd>Ctrl+Shift+E</kbd></div>
  <div class="key-row"><span>Cerrar panel</span>            <kbd>Ctrl+Shift+H</kbd></div>
  <div class="key-row"><span>Finalizar sesión</span>        <kbd>escribir "finalizar"</kbd></div>
  <br>
  <div class="key-row" style="font-size:9px;color:var(--fg-dimmer);">*Solo funciona con sesión activa</div>
</div>

<!-- ══ MODALS ══ -->

<!-- TIMER -->
<div class="modal-wrap" id="modal-timer">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-timer">×</button>
    <div class="modal-title">TIMER DE ESCRITURA</div>
    <div class="modal-row">
      <div class="modal-label">MINUTOS</div>
      <input type="number" class="modal-input" id="timer-min" value="20" min="0" max="999">
    </div>
    <div class="modal-row">
      <div class="modal-label">SEGUNDOS</div>
      <input type="number" class="modal-input" id="timer-sec" value="0" min="0" max="59">
    </div>
    <div class="modal-row">
      <div class="modal-label">AL EXPIRAR</div>
      <select class="modal-input" id="timer-expire">
        <option value="freeze">Congelar escritura</option>
        <option value="panic">Borrar todo (modo pánico)</option>
        <option value="notify">Solo notificar</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-timer">CANCELAR</button>
      <button class="btn active" id="timer-start-btn">INICIAR TIMER</button>
    </div>
  </div>
</div>

<!-- SPRINT -->
<div class="modal-wrap" id="modal-sprint">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-sprint">×</button>
    <div class="modal-title">SPRINT DE ESCRITURA</div>
    <div class="modal-row">
      <div class="modal-label">META DE PALABRAS</div>
      <input type="number" class="modal-input" id="sprint-goal" value="500" min="1" max="99999">
    </div>
    <div class="modal-row">
      <div class="modal-label">AL ALCANZAR LA META</div>
      <select class="modal-input" id="sprint-expire">
        <option value="continue">Seguir escribiendo (solo notificar)</option>
        <option value="freeze">Congelar escritura</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-sprint">CANCELAR</button>
      <button class="btn active" id="sprint-start-btn">INICIAR SPRINT</button>
    </div>
  </div>
</div>

<!-- EXPORT ENCRYPTED -->
<div class="modal-wrap" id="modal-export-enc">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-export-enc">×</button>
    <div class="modal-title">EXPORTAR ENCRIPTADO</div>
    <div class="modal-row">
      <div class="modal-label">CONTRASEÑA (mínimo 8 caracteres)</div>
      <input type="password" class="modal-input" id="enc-pass">
    </div>
    <div class="modal-row">
      <div class="modal-label">CONFIRMAR CONTRASEÑA</div>
      <input type="password" class="modal-input" id="enc-pass2">
    </div>
    <div class="modal-row">
      <div class="modal-label">INCLUIR FIRMA CRIPTOGRÁFICA</div>
      <select class="modal-input" id="enc-include-sig">
        <option value="yes">Sí — añadir hash SHA-256 + timestamp</option>
        <option value="no">No</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-export-enc">CANCELAR</button>
      <button class="btn active" id="enc-export-btn">ENCRIPTAR Y DESCARGAR</button>
    </div>
  </div>
</div>

<!-- IMPORT -->
<div class="modal-wrap" id="modal-import">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-import">×</button>
    <div class="modal-title">IMPORTAR ARCHIVO</div>
    <div class="modal-row">
      <div class="modal-label">ARCHIVO (.txt / .cryptpad)</div>
      <input type="file" class="modal-input" id="import-file" accept=".txt,.cryptpad,.enc">
    </div>
    <div id="import-pass-wrap" style="display:none;">
      <div class="modal-row">
        <div class="modal-label">CONTRASEÑA</div>
        <input type="password" class="modal-input" id="import-pass">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-import">CANCELAR</button>
      <button class="btn active" id="import-btn">IMPORTAR</button>
    </div>
  </div>
</div>

<!-- POMODORO -->
<div class="modal-wrap" id="modal-pomo">
  <div class="modal-backdrop"></div>
  <div class="modal-box" style="width:440px;">
    <button class="modal-close-x" data-close="modal-pomo">×</button>
    <div class="modal-title">POMODORO</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0 20px;">
      <div class="modal-row">
        <div class="modal-label">DURACIÓN DE TRABAJO (min)</div>
        <input type="number" class="modal-input" id="pomo-work" value="25" min="1" max="120">
      </div>
      <div class="modal-row">
        <div class="modal-label">DESCANSO CORTO (min)</div>
        <input type="number" class="modal-input" id="pomo-short" value="5" min="1" max="60">
      </div>
      <div class="modal-row">
        <div class="modal-label">DESCANSO LARGO (min)</div>
        <input type="number" class="modal-input" id="pomo-long" value="15" min="1" max="120">
      </div>
      <div class="modal-row">
        <div class="modal-label">POMODOROS ANTES DEL DESCANSO LARGO</div>
        <input type="number" class="modal-input" id="pomo-before-long" value="4" min="1" max="20">
      </div>
      <div class="modal-row">
        <div class="modal-label">NÚMERO TOTAL DE CICLOS (0 = infinito)</div>
        <input type="number" class="modal-input" id="pomo-cycles" value="0" min="0" max="99">
      </div>
      <div class="modal-row">
        <div class="modal-label">CONGELAR ESCRITURA EN DESCANSOS</div>
        <select class="modal-input" id="pomo-freeze-break">
          <option value="yes">Sí</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-pomo">CANCELAR</button>
      <button class="btn active" id="pomo-start-btn">INICIAR POMODORO</button>
    </div>
  </div>
</div>

<!-- CLEAR CONFIRM -->
<div class="modal-wrap" id="modal-clear">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <div class="modal-title">BORRAR TODO EL CONTENIDO</div>
    <p style="font-size:12px;color:var(--fg-dim);line-height:1.75;margin-bottom:20px;">
      Esta acción es irreversible. El texto desaparecerá permanentemente de la memoria del navegador.
    </p>
    <div class="modal-actions">
      <button class="btn" data-close="modal-clear">CANCELAR</button>
      <button class="btn active" id="clear-confirm-btn" style="border-color:#cc3333;background:#cc3333;color:#fff;">BORRAR DEFINITIVAMENTE</button>
    </div>
  </div>
</div>

<script>
// ══════════════════════════════════════════════════════
//  n0t3.zt — ephemeral encrypted notepad
//  no localStorage · no cookies · RAM only
// ══════════════════════════════════════════════════════

const $  = id => document.getElementById(id);
const editor = $('editor');

// ── state ──────────────────────────────────────────────
const S = {
  inverted:   false,
  typewriter: false,
  keysOpen:   false,
  // timer
  timerActive:    false,
  timerRemaining: 0,
  timerInterval:  null,
  timerExpire:    'freeze',
  // session
  sessionActive:   false,
  sessionStart:    null,
  sessionInterval: null,
  sessionElapsed:  0,
  sessionPeakWPM:  0,
  sessionStartWords: 0,
  // sprint
  sprintActive: false,
  sprintGoal:   0,
  sprintBase:   0,
  sprintExpire: 'continue',
  // wpm sliding window
  wpmWindow:  [],
  wpmTick:    null,
};

// ── helpers ────────────────────────────────────────────
function words(t)      { return t.trim() === '' ? 0 : t.trim().split(/\s+/).length; }
function bytes(t)      { return new TextEncoder().encode(t).length; }
function pad2(n)       { return String(n).padStart(2,'0'); }
function fmtDur(sec) {
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  if (h) return `${h}h ${m}m ${s}s`;
  if (m) return `${m}m ${s}s`;
  return `${s}s`;
}
function fmtClock(sec) {
  return `${pad2(Math.floor(sec/3600))}:${pad2(Math.floor((sec%3600)/60))}:${pad2(sec%60)}`;
}
function nowFilename() {
  const d = new Date();
  return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}`;
}

let notifTimer;
function notify(msg, dur=2800) {
  const n=$('notif'); n.textContent=msg; n.classList.add('show');
  clearTimeout(notifTimer);
  notifTimer = setTimeout(()=>n.classList.remove('show'), dur);
}

function openModal(id)  { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

document.querySelectorAll('[data-close]').forEach(b =>
  b.addEventListener('click', ()=> closeModal(b.dataset.close))
);
document.querySelectorAll('.modal-backdrop').forEach(bd =>
  bd.addEventListener('click', ()=> {
    const m = bd.closest('.modal-wrap'); if(m) closeModal(m.id);
  })
);

// ── counters ───────────────────────────────────────────
function updateCounters() {
  const t  = editor.value;
  const w  = words(t);
  $('cnt-words').textContent    = w.toLocaleString();
  $('cnt-chars').textContent    = t.length.toLocaleString();
  $('cnt-chars-ns').textContent = t.replace(/\s/g,'').length.toLocaleString();
  $('cnt-lines').textContent    = (t===''?1:t.split('\n').length).toLocaleString();
  $('cnt-paragraphs').textContent = (t===''?0:t.split(/\n\s*\n/).filter(p=>p.trim()).length).toLocaleString();
  $('cnt-bytes').textContent    = bytes(t).toLocaleString();
  $('cnt-readtime').textContent = w===0?'0 min':Math.ceil(w/200)+' min';

  if (S.sessionActive) S.wpmWindow.push({t:Date.now(), w});

  // sprint progress
  if (S.sprintActive) {
    const gained   = Math.max(0, w - S.sprintBase);
    const progress = Math.min(gained / S.sprintGoal, 1);
    $('sprint-bar').style.width = (progress*100)+'%';
    if (progress >= 1) completeSprint();
  }

  // finalizar keyword
  if (S.sessionActive && editor.value.trimEnd().endsWith('finalizar')) endSession();
}

// ── WPM ────────────────────────────────────────────────
S.wpmTick = setInterval(()=>{
  const now = Date.now();
  S.wpmWindow = S.wpmWindow.filter(p => now-p.t < 30000);
  if (S.wpmWindow.length >= 2) {
    const f=S.wpmWindow[0], l=S.wpmWindow[S.wpmWindow.length-1];
    const dm = (l.t-f.t)/60000;
    const wpm = dm>0 ? Math.round(Math.max(0,l.w-f.w)/dm) : 0;
    $('cnt-wpm').textContent = wpm+' wpm';
    if (S.sessionActive && wpm>S.sessionPeakWPM) S.sessionPeakWPM=wpm;
  } else {
    $('cnt-wpm').textContent = '— wpm';
  }
}, 4000);

// ── width slider ───────────────────────────────────────
$('width-slider').addEventListener('input', function(){
  document.documentElement.style.setProperty('--page-width', this.value+'%');
  $('width-label').textContent = this.value+'%';
});

// ── invert ─────────────────────────────────────────────
function toggleInvert() {
  S.inverted = !S.inverted;
  document.body.classList.toggle('inverted', S.inverted);
  $('btn-invert').classList.toggle('active', S.inverted);
}
$('btn-invert').addEventListener('click', toggleInvert);

// ── POMODORO ───────────────────────────────────────────
const P = {
  active:      false,
  paused:      false,
  phase:       'work',   // 'work' | 'short' | 'long'
  currentCycle: 0,       // completed work cycles
  pomoCurrent:  0,       // work cycles since last long break
  remaining:    0,
  total:        0,
  interval:     null,
  // config
  work:         25,
  short:        5,
  long:         15,
  beforeLong:   4,
  cycles:       0,       // 0 = infinite
  freezeBreak:  true,
};

$('btn-pomo').addEventListener('click', ()=>{
  if (P.active) { stopPomo(); return; }
  openModal('modal-pomo');
});

$('pomo-start-btn').addEventListener('click', ()=>{
  P.work        = parseInt($('pomo-work').value)        || 25;
  P.short       = parseInt($('pomo-short').value)       || 5;
  P.long        = parseInt($('pomo-long').value)        || 15;
  P.beforeLong  = parseInt($('pomo-before-long').value) || 4;
  P.cycles      = parseInt($('pomo-cycles').value)      || 0;
  P.freezeBreak = $('pomo-freeze-break').value === 'yes';
  closeModal('modal-pomo');
  startPomo();
});

function startPomo() {
  P.active       = true;
  P.paused       = false;
  P.phase        = 'work';
  P.currentCycle = 0;
  P.pomoCurrent  = 0;
  buildPomoDots();
  beginPhase('work');
  $('pomo-bar-wrap').classList.add('visible');
  $('btn-pomo').classList.add('active');
  $('btn-pomo').textContent = 'DETENER POMO';
  editor.disabled = false;
}

function beginPhase(phase) {
  P.phase = phase;
  clearInterval(P.interval);

  if (phase === 'work') {
    P.total     = P.work * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = `TRABAJO ${P.currentCycle + 1}${P.cycles ? '/'+P.cycles : ''}`;
    $('pomo-phase').className   = 'work';
    editor.disabled             = false;
    notify(`POMODORO — trabajo ${P.currentCycle + 1}${P.cycles ? ' de '+P.cycles : ''} iniciado`);
  } else if (phase === 'short') {
    P.total     = P.short * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = 'DESCANSO CORTO';
    $('pomo-phase').className   = 'break';
    if (P.freezeBreak) editor.disabled = true;
    notify('DESCANSO CORTO — descansa un momento');
  } else {
    P.total     = P.long * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = 'DESCANSO LARGO';
    $('pomo-phase').className   = 'break';
    if (P.freezeBreak) editor.disabled = true;
    notify('DESCANSO LARGO — buen trabajo');
  }

  updatePomoDisplay();
  P.interval = setInterval(tickPomo, 1000);
}

function tickPomo() {
  if (P.paused) return;
  P.remaining--;
  updatePomoDisplay();
  if (P.remaining <= 0) {
    clearInterval(P.interval);
    onPomoPhaseEnd();
  }
}

function onPomoPhaseEnd() {
  if (P.phase === 'work') {
    P.currentCycle++;
    P.pomoCurrent++;
    markDot(P.currentCycle - 1);

    // check total cycles limit
    if (P.cycles > 0 && P.currentCycle >= P.cycles) {
      stopPomo(true);
      return;
    }

    // decide next break
    if (P.pomoCurrent >= P.beforeLong) {
      P.pomoCurrent = 0;
      beginPhase('long');
    } else {
      beginPhase('short');
    }
  } else {
    // break ended → next work
    buildPomoDots();
    beginPhase('work');
  }
}

function updatePomoDisplay() {
  const m = Math.floor(P.remaining / 60);
  const s = P.remaining % 60;
  $('pomo-clock').textContent = pad2(m) + ':' + pad2(s);
  const pct = P.total > 0 ? ((P.total - P.remaining) / P.total * 100) : 0;
  $('pomo-track-fill').style.width = pct + '%';
}

function buildPomoDots() {
  const container = $('pomo-dots');
  container.innerHTML = '';
  const total = P.cycles > 0 ? P.cycles : P.beforeLong;
  for (let i = 0; i < total; i++) {
    const d = document.createElement('div');
    d.className = 'pomo-dot';
    if (i < P.currentCycle) d.classList.add('done');
    if (i === P.currentCycle) d.classList.add('active');
    container.appendChild(d);
  }
}

function markDot(idx) {
  const dots = $('pomo-dots').querySelectorAll('.pomo-dot');
  if (dots[idx]) {
    dots[idx].classList.remove('active');
    dots[idx].classList.add('done');
  }
  if (dots[idx + 1]) dots[idx + 1].classList.add('active');
}

function stopPomo(completed = false) {
  clearInterval(P.interval);
  P.active  = false;
  P.paused  = false;
  editor.disabled = false;
  $('pomo-bar-wrap').classList.remove('visible');
  $('btn-pomo').classList.remove('active');
  $('btn-pomo').textContent = 'POMODORO';
  $('pomo-track-fill').style.width = '0%';
  if (completed) notify(`POMODORO COMPLETADO — ${P.currentCycle} ciclos finalizados`, 5000);
  else           notify('POMODORO DETENIDO');
}

$('pomo-pause-btn').addEventListener('click', ()=>{
  if (!P.active) return;
  P.paused = !P.paused;
  $('pomo-pause-btn').textContent = P.paused ? 'REANUDAR' : 'PAUSAR';
  $('pomo-pause-btn').classList.toggle('active', P.paused);
  if (P.paused && P.freezeBreak && P.phase !== 'work') {
    // already frozen, fine
  }
  if (!P.paused && P.phase !== 'work' && P.freezeBreak) {
    editor.disabled = true;
  }
  if (!P.paused && P.phase === 'work') {
    editor.disabled = false;
  }
});

$('pomo-skip-btn').addEventListener('click', ()=>{
  if (!P.active) return;
  clearInterval(P.interval);
  onPomoPhaseEnd();
});

$('pomo-stop-btn').addEventListener('click', ()=> stopPomo());

// ── font switcher ──────────────────────────────────────
const FONTS = {
  fira:    { family: "'Fira Code', monospace",  size: '15px', lh: '1.8'  },
  lora:    { family: "'Lora', serif",            size: '17px', lh: '1.9'  },
  nunito:  { family: "'Nunito', sans-serif",     size: '16px', lh: '1.85' },
  syne:    { family: "'Syne Mono', monospace",   size: '14px', lh: '1.8'  },
  archivo: { family: "'Archivo', sans-serif",    size: '15px', lh: '1.75' },
};
$('font-select').addEventListener('change', function() {
  const f = FONTS[this.value];
  document.documentElement.style.setProperty('--editor-font', f.family);
  document.documentElement.style.setProperty('--font-size',   f.size);
  document.documentElement.style.setProperty('--line-height', f.lh);
});

// ── typewriter ─────────────────────────────────────────
function toggleTypewriter() {
  S.typewriter = !S.typewriter;
  $('btn-typewriter').classList.toggle('active', S.typewriter);
  document.body.classList.toggle('typewriter', S.typewriter);
  if (S.typewriter) editor.addEventListener('input', scrollTypewriter);
  else              editor.removeEventListener('input', scrollTypewriter);
}
function scrollTypewriter() {
  const cur = editor.selectionStart;
  const lineN = editor.value.substring(0,cur).split('\n').length;
  const wrap  = $('editor-wrap');
  wrap.scrollTop = Math.max(0, lineN*26 - wrap.clientHeight/2);
}
$('btn-typewriter').addEventListener('click', toggleTypewriter);

// ── CLEAR ─────────────────────────────────────────────
$('btn-clear').addEventListener('click', ()=>openModal('modal-clear'));
$('clear-confirm-btn').addEventListener('click', ()=>{
  editor.value=''; updateCounters(); closeModal('modal-clear'); notify('CONTENIDO BORRADO');
});

// ── TIMER ──────────────────────────────────────────────
$('btn-timer').addEventListener('click', ()=>{
  if (S.timerActive) { stopTimer(); return; }
  openModal('modal-timer');
});
$('timer-start-btn').addEventListener('click', ()=>{
  const min = parseInt($('timer-min').value)||0;
  const sec = parseInt($('timer-sec').value)||0;
  const total = min*60+sec;
  if (total<=0) return notify('TIEMPO INVÁLIDO');
  S.timerExpire = $('timer-expire').value;
  closeModal('modal-timer');
  startTimer(total);
});

function startTimer(seconds) {
  clearInterval(S.timerInterval);
  S.timerActive    = true;
  S.timerRemaining = seconds;
  editor.disabled  = false;
  $('btn-timer').classList.add('active');
  $('btn-timer').textContent = 'DETENER TIMER';
  $('timer-overlay').classList.add('visible');
  $('timer-label').textContent = 'TIMER ACTIVO';
  renderTimerBig();
  S.timerInterval = setInterval(()=>{
    S.timerRemaining--;
    renderTimerBig();
    if (S.timerRemaining <= 0) {
      clearInterval(S.timerInterval);
      S.timerActive = false;
      onTimerExpire();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(S.timerInterval);
  S.timerActive = false;
  $('btn-timer').classList.remove('active');
  $('btn-timer').textContent = 'TIMER';
  $('timer-overlay').classList.remove('visible','warning','expired');
  editor.disabled = false;
  notify('TIMER DETENIDO');
}

function renderTimerBig() {
  const r  = S.timerRemaining;
  const m  = Math.floor(r/60);
  const s  = r%60;
  $('timer-big').textContent = pad2(m)+':'+pad2(s);
  const ov = $('timer-overlay');
  ov.classList.toggle('warning', r<=30 && r>0);
}

function onTimerExpire() {
  $('btn-timer').textContent = 'TIMER';
  $('btn-timer').classList.remove('active');
  $('timer-overlay').classList.remove('warning');
  $('timer-overlay').classList.add('expired');
  $('timer-big').textContent = '00:00';
  $('timer-label').textContent = 'TIEMPO AGOTADO';

  if (S.timerExpire==='freeze') {
    editor.disabled=true;
    notify('TIEMPO AGOTADO — reinicia el timer para continuar', 4000);
  } else if (S.timerExpire==='panic') {
    editor.value=''; updateCounters();
    notify('TIEMPO AGOTADO — CONTENIDO BORRADO', 4000);
    $('timer-overlay').classList.remove('visible','expired');
  } else {
    notify('TIEMPO AGOTADO', 3000);
  }
}

// ── SESSION ────────────────────────────────────────────
$('btn-session').addEventListener('click', ()=>{
  if (S.sessionActive) endSession(); else startSession();
});

function startSession() {
  S.sessionActive    = true;
  S.sessionStart     = new Date();
  S.sessionElapsed   = 0;
  S.sessionPeakWPM   = 0;
  S.sessionStartWords= words(editor.value);
  S.wpmWindow        = [];
  $('btn-session').classList.add('active');
  $('btn-session').textContent = 'FINALIZAR SESIÓN';
  const clock = $('session-clock');
  clock.classList.add('active');
  clock.textContent = '00:00:00';
  S.sessionInterval = setInterval(()=>{
    S.sessionElapsed++;
    clock.textContent = fmtClock(S.sessionElapsed);
  }, 1000);
  notify('SESIÓN INICIADA — escribe "finalizar" para terminar');
}

function endSession() {
  if (!S.sessionActive) return;
  clearInterval(S.sessionInterval);
  S.sessionActive = false;
  $('btn-session').classList.remove('active');
  $('btn-session').textContent = 'SESIÓN';
  $('session-clock').classList.remove('active');

  const end  = new Date();
  const t    = editor.value;
  const w    = words(t);
  const gained  = Math.max(0, w - S.sessionStartWords);
  const totalMin= S.sessionElapsed/60;
  const avgWPM  = totalMin>0 ? Math.round(gained/totalMin) : 0;

  $('s-time').textContent     = fmtDur(S.sessionElapsed);
  $('s-words').textContent    = gained.toLocaleString();
  $('s-chars').textContent    = t.length.toLocaleString();
  $('s-bytes').textContent    = bytes(t).toLocaleString();
  $('s-lines').textContent    = (t===''?1:t.split('\n').length).toLocaleString();
  $('s-wpm-avg').textContent  = avgWPM+' wpm';
  $('s-wpm-peak').textContent = S.sessionPeakWPM+' wpm';
  $('s-start').textContent    = S.sessionStart.toLocaleTimeString();
  $('s-end').textContent      = end.toLocaleTimeString();

  $('stats-overlay').classList.add('open');

  if (editor.value.trimEnd().endsWith('finalizar')) {
    const idx = editor.value.lastIndexOf('finalizar');
    editor.value = editor.value.slice(0, idx);
    updateCounters();
  }
}

$('stats-close').addEventListener('click', ()=>$('stats-overlay').classList.remove('open'));
$('stats-export').addEventListener('click', ()=>{
  const lines = [
    'n0t3.zt — RESUMEN DE SESIÓN',
    '─'.repeat(36),
    'Inicio:           '+$('s-start').textContent,
    'Fin:              '+$('s-end').textContent,
    'Tiempo total:     '+$('s-time').textContent,
    'Palabras escritas:'+$('s-words').textContent,
    'Caracteres:       '+$('s-chars').textContent,
    'Líneas:           '+$('s-lines').textContent,
    'Bytes:            '+$('s-bytes').textContent,
    'Vel. promedio:    '+$('s-wpm-avg').textContent,
    'Vel. pico:        '+$('s-wpm-peak').textContent,
  ].join('\n');
  downloadText(lines, 'sesion-'+nowFilename()+'.txt');
  $('stats-overlay').classList.remove('open');
});

// ── SPRINT ─────────────────────────────────────────────
$('btn-sprint').addEventListener('click', ()=>{
  if (S.sprintFrozen) { resumeFromSprint(); return; }
  if (S.sprintActive) { endSprint(); return; }
  openModal('modal-sprint');
});

function resumeFromSprint() {
  S.sprintFrozen=false;
  editor.disabled=false;
  editor.focus();
  $('btn-sprint').classList.remove('active');
  $('btn-sprint').textContent='SPRINT';
  $('sprint-bar-wrap').style.display='none';
  $('sprint-bar').style.background='var(--fg)';
  notify('ESCRITURA REANUDADA');
}
$('sprint-start-btn').addEventListener('click', ()=>{
  const goal = parseInt($('sprint-goal').value);
  if (!goal||goal<1) return notify('META INVÁLIDA');
  S.sprintGoal   = goal;
  S.sprintBase   = words(editor.value);
  S.sprintExpire = $('sprint-expire').value;
  S.sprintActive = true;
  $('sprint-bar-wrap').style.display='block';
  $('sprint-bar').style.width='0%';
  $('btn-sprint').classList.add('active');
  $('btn-sprint').textContent = 'DETENER SPRINT';
  closeModal('modal-sprint');
  notify(`SPRINT: META ${goal} PALABRAS`);
});

function completeSprint() {
  S.sprintActive=false;
  $('sprint-bar').style.background='#22aa55';

  if (S.sprintExpire==='freeze') {
    editor.disabled=true;
    $('btn-sprint').classList.add('active');
    $('btn-sprint').textContent='REANUDAR ESCRITURA';
    // next click on btn-sprint will unfreeze
    S.sprintFrozen=true;
    notify('¡SPRINT COMPLETADO! Pulsa REANUDAR ESCRITURA para continuar.', 5000);
  } else {
    $('btn-sprint').classList.remove('active');
    $('btn-sprint').textContent='SPRINT';
    notify('¡SPRINT COMPLETADO! Puedes seguir escribiendo.', 4000);
    setTimeout(()=>{
      $('sprint-bar-wrap').style.display='none';
      $('sprint-bar').style.background='var(--fg)';
    }, 5000);
  }
}

function endSprint() {
  S.sprintActive=false;
  $('sprint-bar-wrap').style.display='none';
  $('btn-sprint').classList.remove('active');
  $('btn-sprint').textContent='SPRINT';
  editor.disabled=false;
  notify('SPRINT CANCELADO');
}

// ── EXPORT .TXT ────────────────────────────────────────
$('btn-export').addEventListener('click', exportTxt);
async function exportTxt() {
  const t = editor.value;
  if (!t.trim()) return notify('NADA QUE EXPORTAR');
  const sig = await buildSignature(t);
  const out  = t + '\n\n' + sig;
  downloadText(out, 'nota-'+nowFilename()+'.txt');
}

// ── EXPORT ENCRYPTED ───────────────────────────────────
$('btn-export-enc').addEventListener('click', ()=>openModal('modal-export-enc'));
$('enc-export-btn').addEventListener('click', async ()=>{
  const p1 = $('enc-pass').value;
  const p2 = $('enc-pass2').value;
  if (p1.length<8) return notify('CONTRASEÑA MUY CORTA (mínimo 8 caracteres)');
  if (p1!==p2)     return notify('LAS CONTRASEÑAS NO COINCIDEN');
  const t = editor.value;
  if (!t.trim()) return notify('NADA QUE EXPORTAR');
  try {
    let payload = t;
    if ($('enc-include-sig').value==='yes') {
      payload = t + '\n\n' + await buildSignature(t);
    }
    const enc  = await encryptText(payload, p1);
    downloadText(enc, 'nota-'+nowFilename()+'.cryptpad');
    closeModal('modal-export-enc');
    $('enc-pass').value=''; $('enc-pass2').value='';
    notify('EXPORTADO Y ENCRIPTADO (AES-256-GCM)');
  } catch(e) { notify('ERROR AL ENCRIPTAR'); console.error(e); }
});

// ── IMPORT ─────────────────────────────────────────────
$('btn-import').addEventListener('click', ()=>openModal('modal-import'));
$('import-file').addEventListener('change', function(){
  const enc = this.files[0]?.name.match(/\.(cryptpad|enc)$/);
  $('import-pass-wrap').style.display = enc ? 'block' : 'none';
});
$('import-btn').addEventListener('click', async ()=>{
  const f = $('import-file').files[0];
  if (!f) return notify('SELECCIONA UN ARCHIVO');
  const isEnc = /\.(cryptpad|enc)$/.test(f.name);
  const reader = new FileReader();
  reader.onload = async e=>{
    let text = e.target.result;
    if (isEnc) {
      const pass = $('import-pass').value;
      if (!pass) return notify('INTRODUCE LA CONTRASEÑA');
      try { text = await decryptText(text); }
      catch { return notify('ERROR: CONTRASEÑA INCORRECTA O ARCHIVO DAÑADO'); }
      // decryptText doesn't use pass yet — fixed below
    }
    editor.value=text; updateCounters(); closeModal('modal-import'); notify('IMPORTADO');
  };
  reader.readAsText(f);
});

// ── SHA-256 SIGNATURE ─────────────────────────────────
async function sha256hex(text) {
  const buf  = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function buildSignature(text) {
  const ts   = new Date().toISOString();
  const hash = await sha256hex(text + '|' + ts);
  return [
    '─'.repeat(60),
    'n0t3.zt · FIRMA CRIPTOGRÁFICA',
    'Timestamp : ' + ts,
    'SHA-256   : ' + hash,
    'Verificar : sha256( contenido_literal + "|" + timestamp )',
    '─'.repeat(60),
  ].join('\n');
}

// ── CRYPTO AES-256-GCM ────────────────────────────────
async function encryptText(plaintext, password) {
  const enc  = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const km   = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key  = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
    km, {name:'AES-GCM',length:256}, false, ['encrypt']
  );
  const buf  = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plaintext));
  const combined = new Uint8Array(salt.length+iv.length+buf.byteLength);
  combined.set(salt,0); combined.set(iv,16); combined.set(new Uint8Array(buf),28);
  return 'N0T3ZT_V1:' + btoa(String.fromCharCode(...combined));
}

async function decryptText(ciphertext, password) {
  if (!ciphertext.startsWith('N0T3ZT_V1:') && !ciphertext.startsWith('CRYPTPAD_V1:'))
    throw new Error('Formato inválido');
  const prefix = ciphertext.startsWith('N0T3ZT_V1:') ? 'N0T3ZT_V1:' : 'CRYPTPAD_V1:';
  const combined = Uint8Array.from(atob(ciphertext.slice(prefix.length)), c=>c.charCodeAt(0));
  const salt=combined.slice(0,16), iv=combined.slice(16,28), data=combined.slice(28);
  const enc = new TextEncoder();
  const km  = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
    km, {name:'AES-GCM',length:256}, false, ['decrypt']
  );
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
  return new TextDecoder().decode(plain);
}

// ── DOWNLOAD ───────────────────────────────────────────
function downloadText(text, filename) {
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
  notify('DESCARGADO: '+filename);
}

// ── EDITOR EVENTS ──────────────────────────────────────
editor.addEventListener('input', updateCounters);

editor.addEventListener('select', updateSelectionCounters);
editor.addEventListener('mouseup', updateSelectionCounters);
editor.addEventListener('keyup', updateSelectionCounters);

function updateSelectionCounters() {
  const start = editor.selectionStart;
  const end   = editor.selectionEnd;
  if (start === end) {
    // no selection — restore full counters
    $('selection-badge').classList.remove('visible');
    updateCounters();
    return;
  }
  const sel = editor.value.slice(start, end);
  const w   = words(sel);
  $('selection-badge').classList.add('visible');
  $('cnt-words').textContent    = w.toLocaleString();
  $('cnt-chars').textContent    = sel.length.toLocaleString();
  $('cnt-chars-ns').textContent = sel.replace(/\s/g,'').length.toLocaleString();
  $('cnt-lines').textContent    = sel.split('\n').length.toLocaleString();
  $('cnt-paragraphs').textContent = (sel.split(/\n\s*\n/).filter(p=>p.trim()).length||0).toLocaleString();
  $('cnt-bytes').textContent    = bytes(sel).toLocaleString();
  $('cnt-readtime').textContent = w===0 ? '0 min' : Math.ceil(w/200)+' min';
}

editor.addEventListener('paste', e=>{
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData('text/plain');
  document.execCommand('insertText', false, text);
});

// ── KEYBOARD SHORTCUTS ─────────────────────────────────
document.addEventListener('keydown', e=>{
  const ctrl = e.ctrlKey||e.metaKey;
  if (ctrl && e.key==='i')                         { e.preventDefault(); toggleInvert(); }
  if (ctrl && e.key==='t')                         { e.preventDefault(); toggleTypewriter(); }
  if (ctrl && e.key==='s')                         { e.preventDefault(); exportTxt(); }
  if (ctrl && e.shiftKey && e.key==='C')           { e.preventDefault(); copyAll(); }
  if (ctrl && e.shiftKey && e.key==='X')           { e.preventDefault(); openModal('modal-clear'); }
  if (ctrl && e.shiftKey && e.key==='T')           { e.preventDefault(); openModal('modal-timer'); }
  if (ctrl && e.shiftKey && (e.key==='P'||e.key==='p')) { e.preventDefault(); openModal('modal-sprint'); }
  if (ctrl && e.shiftKey && (e.key==='O'||e.key==='o')) { e.preventDefault(); P.active?stopPomo():openModal('modal-pomo'); }
  if (ctrl && e.shiftKey && (e.key==='E'||e.key==='e')) { e.preventDefault(); S.sessionActive?endSession():startSession(); }
  if (ctrl && e.shiftKey && (e.key==='H'||e.key==='h')) { e.preventDefault(); S.keysOpen=!S.keysOpen; $('keys-panel').classList.toggle('open',S.keysOpen); }
  if (e.key==='Escape') {
    document.querySelectorAll('.modal-wrap.open').forEach(m=>closeModal(m.id));
    $('stats-overlay').classList.remove('open');
    if (S.keysOpen) { S.keysOpen=false; $('keys-panel').classList.remove('open'); }
  }
});

function copyAll() {
  if (!editor.value) return notify('NADA QUE COPIAR');
  navigator.clipboard.writeText(editor.value).then(()=>notify('COPIADO AL PORTAPAPELES'));
}

// ── PREVENT ACCIDENTAL CLOSE ───────────────────────────
window.addEventListener('beforeunload', e=>{
  if (editor.value.trim().length>0) { e.preventDefault(); e.returnValue=''; }
});

// ── INIT ───────────────────────────────────────────────
updateCounters();
editor.focus();
</script>
</body>
</html>
