<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>n0t3.xyz</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&family=Lora:ital,wght@0,400;0,500;1,400&family=Nunito:ital,wght@0,300;0,400;1,300&family=Syne+Mono&family=Archivo:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet">
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #ffffff;
    --fg: #000000;
    --fg-dim: #888888;
    --fg-dimmer: #cccccc;
    --line: #e0e0e0;
    --ui-font: 'Fira Code', monospace;
    --editor-font: 'Fira Code', monospace;
    --font-size: 15px;
    --line-height: 1.8;
    --page-width: 65%;
  }

  .inverted {
    --bg: #0a0a0a;
    --fg: #e8e8e8;
    --fg-dim: #555555;
    --fg-dimmer: #2a2a2a;
    --line: #1e1e1e;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 16px;
    transition: background 0.2s, color 0.2s;
    overflow: hidden;
  }

  #app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* ‚ïê‚ïê TOPBAR ‚ïê‚ïê */
  #topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 9px 20px;
    border-bottom: 1px solid var(--line);
    flex-shrink: 0;
    gap: 10px;
    flex-wrap: wrap;
  }

  #topbar-left  { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  #topbar-right { display: flex; align-items: center; gap: 7px;  flex-wrap: wrap; }

  .logo {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 0.08em;
    color: var(--fg);
  }

  .sep { color: var(--fg-dimmer); font-size: 13px; user-select: none; }

  /* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
  .btn {
    background: none;
    border: 1px solid var(--line);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 12px;
    letter-spacing: 0.07em;
    padding: 4px 10px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
    white-space: nowrap;
  }
  .btn:hover  { border-color: var(--fg); }
  .btn.active { background: var(--fg); color: var(--bg); }
  .btn:disabled { opacity: 0.28; cursor: not-allowed; }

  .btn-ghost {
    background: none; border: none;
    color: var(--fg-dim);
    font-family: var(--ui-font);
    font-size: 13px;
    cursor: pointer; padding: 4px 6px;
    transition: color 0.15s;
  }
  .btn-ghost:hover { color: var(--fg); }

  /* ‚ïê‚ïê MARGIN CONTROL ‚ïê‚ïê */
  #margin-control { display: flex; align-items: center; gap: 6px; }
  .margin-label { font-size: 12px; color: var(--fg-dim); }
  .margin-input {
    width: 52px;
    background: none;
    border: 1px solid var(--line);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 12px;
    padding: 3px 6px;
    outline: none;
    text-align: center;
    transition: border-color 0.15s;
    -moz-appearance: textfield;
  }
  .margin-input::-webkit-inner-spin-button,
  .margin-input::-webkit-outer-spin-button { -webkit-appearance: none; }
  .margin-input:focus { border-color: var(--fg); }

  /* ‚ïê‚ïê EDITOR ‚ïê‚ïê */
  #editor-wrap {
    flex: 1;
    overflow: hidden;
    display: flex;
  }

  #page {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    margin-left: 120px;
    margin-right: 120px;
  }

  #editor {
    flex: 1;
    width: 100%;
    padding: 52px 0;
    background: transparent;
    border: none; outline: none;
    color: var(--fg);
    font-family: var(--editor-font);
    font-size: var(--font-size);
    font-weight: 300;
    line-height: var(--line-height);
    resize: none;
    caret-color: var(--fg);
    word-break: break-word;
    overflow-wrap: break-word;
    overflow-y: auto;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
  }
  #editor::placeholder { color: var(--fg-dimmer); font-style: italic; }
  #editor:disabled     { opacity: 0.3; cursor: not-allowed; }

  /* ‚ïê‚ïê TIMER OVERLAY ‚ïê‚ïê */
  #timer-overlay {
    display: none;
    position: fixed;
    top: 52px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 80;
    text-align: center;
    pointer-events: none;
    user-select: none;
  }
  #timer-overlay.visible { display: block; }

  #timer-big {
    font-size: 72px;
    font-weight: 300;
    letter-spacing: -0.02em;
    line-height: 1;
    color: var(--fg);
    opacity: 0.07;
    transition: opacity 0.3s, color 0.3s, font-size 0.3s;
  }
  #timer-overlay.warning #timer-big {
    opacity: 0.18;
    color: #cc3333;
  }
  #timer-overlay.expired #timer-big {
    opacity: 0.35;
    color: #cc3333;
  }
  #timer-label {
    font-size: 12px;
    letter-spacing: 0.15em;
    color: var(--fg-dim);
    opacity: 0.5;
    margin-top: 4px;
  }

  /* ‚ïê‚ïê SPRINT BAR ‚ïê‚ïê */
  #sprint-bar-wrap {
    display: none;
    height: 2px;
    background: var(--line);
    flex-shrink: 0;
    position: relative;
  }
  #sprint-bar {
    height: 100%;
    background: var(--fg);
    width: 0%;
    transition: width 0.6s;
  }

  /* ‚ïê‚ïê STATUSBAR ‚ïê‚ïê */
  #statusbar {
    border-top: 1px solid var(--line);
    padding: 8px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
    flex-shrink: 0;
  }

  #counters { display: flex; gap: 18px; flex-wrap: wrap; align-items: center; }

  #selection-badge {
    font-size: 12px;
    color: var(--bg);
    background: var(--fg);
    padding: 2px 8px;
    letter-spacing: 0.06em;
    display: none;
    white-space: nowrap;
  }
  #selection-badge.visible { display: inline; }

  .stat {
    font-size: 12px;
    color: var(--fg-dim);
    letter-spacing: 0.03em;
    white-space: nowrap;
  }
  .stat strong { color: var(--fg); font-weight: 500; }

  #status-right { display: flex; align-items: center; gap: 12px; }

  #session-clock {
    font-size: 13px;
    letter-spacing: 0.1em;
    color: var(--fg-dim);
    display: none;
  }
  #session-clock.active { display: inline; color: var(--fg); }

  /* ‚ïê‚ïê MODALS ‚ïê‚ïê */
  .modal-wrap {
    display: none;
    position: fixed; inset: 0; z-index: 100;
    align-items: center; justify-content: center;
  }
  .modal-wrap.open { display: flex; }

  .modal-backdrop {
    position: absolute; inset: 0;
    background: var(--bg); opacity: 0.88;
  }
  .modal-box {
    position: relative;
    background: var(--bg);
    border: 1px solid var(--fg);
    padding: 30px 34px;
    width: 400px; max-width: 92vw;
    font-family: var(--ui-font);
    z-index: 1;
  }
  .modal-title {
    font-size: 12px; letter-spacing: 0.2em;
    font-weight: 500; margin-bottom: 22px;
  }
  .modal-row { margin-bottom: 14px; }
  .modal-label {
    font-size: 12px; color: var(--fg-dim);
    letter-spacing: 0.08em; margin-bottom: 5px;
  }
  .modal-input {
    width: 100%; background: none;
    border: 1px solid var(--line);
    color: var(--fg); font-family: var(--ui-font);
    font-size: 14px; padding: 7px 10px;
    outline: none; transition: border-color 0.15s;
  }
  .modal-input:focus { border-color: var(--fg); }
  .modal-input[type="file"] { padding: 5px; }
  .modal-actions {
    display: flex; gap: 8px;
    margin-top: 22px; justify-content: flex-end;
  }
  .modal-close-x {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none;
    color: var(--fg-dim); font-size: 18px;
    cursor: pointer; font-family: var(--ui-font); line-height: 1;
  }

  /* ‚ïê‚ïê STATS OVERLAY ‚ïê‚ïê */
  #stats-overlay {
    display: none;
    position: fixed; inset: 0; z-index: 150;
    align-items: center; justify-content: center;
    background: var(--bg); font-family: var(--ui-font);
  }
  #stats-overlay.open { display: flex; }
  .stats-box {
    border: 1px solid var(--fg);
    padding: 36px 44px;
    max-width: 440px; width: 92%;
  }
  .stats-title {
    font-size: 12px; letter-spacing: 0.2em;
    font-weight: 500; margin-bottom: 26px;
  }
  .stats-row {
    display: flex; justify-content: space-between;
    font-size: 13px; margin-bottom: 10px; color: var(--fg-dim);
  }
  .stats-row strong { color: var(--fg); font-weight: 500; }
  .stats-actions { margin-top: 28px; display: flex; gap: 10px; flex-wrap: wrap; }

  /* ‚ïê‚ïê HASH BLOCK ‚ïê‚ïê */
  .hash-block {
    margin-top: 18px;
    border-top: 1px solid var(--line);
    padding-top: 14px;
  }
  .hash-label { font-size: 9px; letter-spacing: 0.12em; color: var(--fg-dim); margin-bottom: 6px; }
  .hash-val {
    font-size: 9px; color: var(--fg);
    word-break: break-all; line-height: 1.6; opacity: 0.7;
  }
  .hash-ts { font-size: 9px; color: var(--fg-dim); margin-top: 4px; }

  /* ‚ïê‚ïê NOTIFICATION ‚ïê‚ïê */
  #notif {
    position: fixed; bottom: 52px; left: 50%;
    transform: translateX(-50%);
    background: var(--fg); color: var(--bg);
    font-family: var(--ui-font); font-size: 12px;
    letter-spacing: 0.1em; padding: 8px 18px;
    z-index: 200; opacity: 0; pointer-events: none;
    transition: opacity 0.22s; white-space: nowrap;
  }
  #notif.show { opacity: 1; }

  /* ‚ïê‚ïê KEYS PANEL ‚ïê‚ïê */
  #keys-panel {
    position: fixed; right: 0; top: 0; bottom: 0;
    width: 270px; background: var(--bg);
    border-left: 1px solid var(--line);
    padding: 24px 22px; z-index: 90;
    overflow-y: auto; font-family: var(--ui-font);
    transform: translateX(100%);
    transition: transform 0.22s;
  }
  #keys-panel.open { transform: translateX(0); }
  .keys-title { font-size: 12px; letter-spacing: 0.15em; font-weight: 500; margin-bottom: 20px; }
  .key-row {
    display: flex; justify-content: space-between;
    margin-bottom: 9px; font-size: 12px; color: var(--fg-dim);
    gap: 10px;
  }
  .key-row kbd { color: var(--fg); font-family: var(--ui-font); font-size: 12px; white-space: nowrap; }

  /* ‚ïê‚ïê POMODORO BAR ‚ïê‚ïê */
  #pomo-bar-wrap {
    display: none;
    flex-shrink: 0;
    border-bottom: 1px solid var(--line);
    padding: 6px 20px;
    align-items: center;
    gap: 14px;
    flex-wrap: wrap;
  }
  #pomo-bar-wrap.visible { display: flex; }

  #pomo-phase {
    font-size: 12px;
    letter-spacing: 0.12em;
    font-weight: 500;
    min-width: 120px;
    white-space: nowrap;
  }
  #pomo-phase.work  { color: var(--fg); }
  #pomo-phase.break { color: var(--fg-dim); }

  #pomo-clock {
    font-size: 13px;
    letter-spacing: 0.1em;
    font-weight: 500;
    min-width: 56px;
  }

  #pomo-dots {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .pomo-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    border: 1px solid var(--fg-dim);
    transition: background 0.3s;
  }
  .pomo-dot.done  { background: var(--fg); border-color: var(--fg); }
  .pomo-dot.active { background: none; border-color: var(--fg); box-shadow: 0 0 0 2px var(--fg); }

  #pomo-track {
    flex: 1;
    height: 2px;
    background: var(--line);
    min-width: 80px;
    max-width: 200px;
    position: relative;
  }
  #pomo-track-fill {
    height: 100%;
    background: var(--fg);
    width: 0%;
    transition: width 1s linear;
  }

  #pomo-controls { display: flex; gap: 6px; margin-left: auto; }

  /* ‚ïê‚ïê DRIVE FILE LIST ‚ïê‚ïê */
  .drive-file-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 9px 4px;
    border-bottom: 1px solid var(--line);
    cursor: pointer;
    transition: background 0.1s;
    gap: 12px;
  }
  .drive-file-row:hover { background: var(--fg); }
  .drive-file-row:hover .drive-file-name,
  .drive-file-row:hover .drive-file-meta { color: var(--bg); }
  .drive-file-name { font-size: 12px; color: var(--fg); }
  .drive-file-meta { font-size: 10px; color: var(--fg-dim); white-space: nowrap; }

  /* ‚ïê‚ïê RULER ‚ïê‚ïê */
  #ruler {
    flex-shrink: 0;
    height: 24px;
    background: var(--bg);
    border-bottom: 1px solid var(--line);
    position: relative;
    overflow: visible;
    user-select: none;
    transition: background 0.2s;
  }

  #ruler-track {
    position: absolute;
    top: 0; bottom: 0;
    left: 0; right: 0;
  }

  /* tick marks */
  #ruler-ticks {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .ruler-handle {
    position: absolute;
    top: 0;
    width: 12px;
    height: 100%;
    cursor: ew-resize;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
  }
  .ruler-handle::before {
    content: '';
    width: 2px;
    height: 14px;
    background: var(--fg);
    opacity: 0.5;
    transition: opacity 0.15s;
  }
  .ruler-handle:hover::before,
  .ruler-handle.dragging::before {
    opacity: 1;
  }
  /* arrow caps */
  .ruler-handle::after {
    content: '';
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    border: 5px solid transparent;
  }
  #handle-left {
    transform: translateX(-50%);
  }
  #handle-left::after {
    border-right-color: var(--fg);
    left: -2px;
    opacity: 0.5;
  }
  #handle-right {
    transform: translateX(-50%);
  }
  #handle-right::after {
    border-left-color: var(--fg);
    right: -2px;
    opacity: 0.5;
  }
  #handle-left:hover::after,
  #handle-left.dragging::after,
  #handle-right:hover::after,
  #handle-right.dragging::after {
    opacity: 1;
  }

  /* shaded margin areas */
  #ruler-shade-left,
  #ruler-shade-right {
    position: absolute;
    top: 0; bottom: 0;
    background: var(--fg);
    opacity: 0.04;
    pointer-events: none;
    transition: background 0.2s;
  }
  #ruler-shade-left  { left: 0; }
  #ruler-shade-right { right: 0; }

  /* margin tooltip */
  #ruler-tooltip {
    position: absolute;
    top: 26px;
    background: var(--fg);
    color: var(--bg);
    font-family: var(--ui-font);
    font-size: 10px;
    padding: 3px 7px;
    letter-spacing: 0.06em;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    white-space: nowrap;
    z-index: 10;
    transform: translateX(-50%);
  }
  #ruler-tooltip.show { opacity: 1; }

  /* ‚ïê‚ïê TOOLS DROPDOWN ‚ïê‚ïê */
  #tools-dropdown { position: relative; }
  #drive-dropdown { position: relative; }

  #tools-menu {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: var(--bg);
    border: 1px solid var(--fg);
    z-index: 300;
    min-width: 160px;
    flex-direction: column;
  }
  #tools-menu.open { display: flex; }

  #drive-menu {
    display: none;
    position: absolute;
    top: calc(100% + 6px);
    right: 0;
    background: var(--bg);
    border: 1px solid var(--fg);
    z-index: 300;
    min-width: 180px;
    flex-direction: column;
  }
  #drive-menu.open { display: flex; }

  .tools-menu-item {
    background: none;
    border: none;
    border-bottom: 1px solid var(--line);
    color: var(--fg);
    font-family: var(--ui-font);
    font-size: 12px;
    letter-spacing: 0.07em;
    padding: 9px 14px;
    text-align: left;
    cursor: pointer;
    transition: background 0.12s;
    white-space: nowrap;
  }
  .tools-menu-item:last-child { border-bottom: none; }
  .tools-menu-item:hover { background: var(--fg); color: var(--bg); }
  .tools-menu-item.active { background: var(--fg); color: var(--bg); }

  /* ‚ïê‚ïê TOPBAR TOGGLE ‚ïê‚ïê */
  #topbar-toggle {
    position: absolute;
    right: 0;
    top: 0;
    width: 18px;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 50;
    background: none;
    border: none;
    color: var(--fg-dim);
    font-size: 9px;
  }
  #topbar:hover #topbar-toggle { opacity: 1; }

  #topbar-stub {
    display: none;
    align-items: center;
    padding: 5px 20px 5px 16px;
    border-bottom: 1px solid var(--line);
    flex-shrink: 0;
    position: relative;
  }
  #topbar-stub.visible { display: flex; }
  .stub-logo { font-size: 12px; font-weight: 500; letter-spacing: 0.08em; opacity: 0.4; }
  #topbar-show {
    position: absolute;
    right: 0;
    top: 0; bottom: 0;
    width: 18px;
    display: flex; align-items: center; justify-content: center;
    background: none; border: none;
    color: var(--fg-dim); font-size: 9px;
    cursor: pointer; opacity: 0;
    transition: opacity 0.2s;
  }
  #topbar-stub:hover #topbar-show { opacity: 1; }

  /* ‚ïê‚ïê TYPEWRITER MODE ‚ïê‚ïê */
  body.typewriter #editor-wrap { align-items: flex-start; }

  /* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
  #editor::-webkit-scrollbar { width: 3px; }
  #editor::-webkit-scrollbar-thumb { background: var(--fg-dimmer); }
</style>
</head>
<body>
<div id="app">

  <!-- TOP BAR -->
  <div id="topbar" style="position:relative;">
    <div id="topbar-left">
      <span class="logo">n0t3.xyz</span>
      <span class="sep">¬∑</span>
      <button class="btn" id="btn-invert">INVERTIR</button>
      <span class="sep">¬∑</span>
      <select id="font-select" class="btn" style="padding:4px 6px; cursor:pointer;">
        <option value="fira">Fira Code</option>
        <option value="lora">Lora</option>
        <option value="nunito">Nunito</option>
        <option value="syne">Syne Mono</option>
        <option value="archivo">Archivo</option>
      </select>
      <select id="size-select" class="btn" style="padding:4px 6px; cursor:pointer;">
        <option value="s">S</option>
        <option value="m">M</option>
        <option value="l">L</option>
      </select>
    </div>
    <div id="topbar-right">
      <!-- Tools dropdown -->
      <div id="tools-dropdown">
        <button class="btn" id="btn-tools">HERRAMIENTAS ‚ñæ</button>
        <div id="tools-menu">
          <button class="tools-menu-item" id="tmenu-sprint">Sprint</button>
          <button class="tools-menu-item" id="tmenu-timer">Timer</button>
          <button class="tools-menu-item" id="tmenu-session">Sesi√≥n</button>
          <button class="tools-menu-item" id="tmenu-pomo">Pomodoro</button>
        </div>
      </div>
      <span class="sep">¬∑</span>
      <button class="btn" id="btn-export">EXPORTAR .TXT</button>
      <button class="btn" id="btn-export-enc">EXPORTAR ENC</button>
      <button class="btn" id="btn-import">IMPORTAR</button>
      <span class="sep">¬∑</span>
      <div id="drive-dropdown">
        <button class="btn" id="btn-drive-connect">DRIVE</button>
        <div id="drive-menu">
          <button class="tools-menu-item" id="dmenu-save" style="display:none;">Guardar en Drive</button>
          <button class="tools-menu-item" id="dmenu-open" style="display:none;">Abrir desde Drive</button>
          <button class="tools-menu-item" id="dmenu-disconnect" style="display:none; color:#cc3333;">Desconectar Drive</button>
        </div>
      </div>
      <!-- hidden proxies for Drive JS -->
      <button id="btn-drive-save"  style="display:none;"></button>
      <button id="btn-drive-open"  style="display:none;"></button>
      <span class="sep">¬∑</span>
      <button class="btn" id="btn-clear" style="border-color:#cc3333; color:#cc3333;">BORRAR TODO</button>
      <button id="btn-nuke" title="Borrar todo y desconectar" style="background:none;border:none;cursor:pointer;font-size:16px;padding:2px 4px;line-height:1;opacity:0.6;transition:opacity 0.15s;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.6">üî•</button>
      <button class="btn-ghost" id="btn-keys" title="Atajos de teclado (Ctrl+Shift+H)">?</button>
    </div>
    <button id="topbar-toggle" title="Ocultar barra">‚ñ≤</button>
  </div>

  <!-- TOPBAR STUB (visible when topbar hidden) -->
  <div id="topbar-stub">
    <span class="stub-logo">n0t3.xyz</span>
    <button id="topbar-show" title="Mostrar barra">‚ñº</button>
  </div>

  <!-- Hidden proxy buttons for tool JS listeners -->
  <div style="display:none;">
    <button id="btn-sprint"></button>
    <button id="btn-timer"></button>
    <button id="btn-session"></button>
    <button id="btn-pomo"></button>
  </div>

  <!-- SPRINT PROGRESS BAR -->
  <div id="sprint-bar-wrap"><div id="sprint-bar"></div></div>

  <!-- POMODORO BAR -->
  <div id="pomo-bar-wrap">
    <span id="pomo-phase" class="work">TRABAJO</span>
    <span id="pomo-clock">25:00</span>
    <div id="pomo-dots"></div>
    <div id="pomo-track"><div id="pomo-track-fill"></div></div>
    <div id="pomo-controls">
      <button class="btn" id="pomo-pause-btn">PAUSAR</button>
      <button class="btn" id="pomo-skip-btn">SALTAR</button>
      <button class="btn" id="pomo-stop-btn">DETENER</button>
    </div>
  </div>

  <!-- RULER -->
  <div id="ruler">
    <div id="ruler-shade-left"></div>
    <div id="ruler-shade-right"></div>
    <canvas id="ruler-ticks"></canvas>
    <div class="ruler-handle" id="handle-left"></div>
    <div class="ruler-handle" id="handle-right"></div>
    <div id="ruler-tooltip"></div>
  </div>

  <!-- TIMER OVERLAY (watermark behind text) -->
  <div id="timer-overlay">
    <div id="timer-big">00:00</div>
    <div id="timer-label">TIMER ACTIVO</div>
  </div>

  <!-- EDITOR -->
  <div id="editor-wrap">
    <div id="page">
      <textarea id="editor" placeholder="empieza a escribir‚Ä¶" spellcheck="false"
        autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
    </div>
  </div>

  <!-- STATUS BAR -->
  <div id="statusbar">
    <div id="counters">
      <span id="selection-badge">SELECCI√ìN</span>
      <div class="stat">Palabras <strong id="cnt-words">0</strong></div>
      <div class="stat">Caracteres <strong id="cnt-chars">0</strong></div>
      <div class="stat">Sin espacios <strong id="cnt-chars-ns">0</strong></div>
      <div class="stat">L√≠neas <strong id="cnt-lines">1</strong></div>
      <div class="stat">P√°rrafos <strong id="cnt-paragraphs">0</strong></div>
      <div class="stat">Bytes <strong id="cnt-bytes">0</strong></div>
      <div class="stat">Lectura <strong id="cnt-readtime">0 min</strong></div>
      <div class="stat">Vel. escritura <strong id="cnt-wpm">‚Äî wpm</strong></div>
    </div>
    <div id="status-right">
      <span id="session-clock">00:00:00</span>
    </div>
  </div>
</div>

<!-- NOTIFICATION -->
<div id="notif"></div>

<!-- STATS OVERLAY -->
<div id="stats-overlay">
  <div class="stats-box">
    <div class="stats-title">RESUMEN DE SESI√ìN</div>
    <div class="stats-row">Tiempo total         <strong id="s-time">‚Äî</strong></div>
    <div class="stats-row">Palabras escritas     <strong id="s-words">‚Äî</strong></div>
    <div class="stats-row">Caracteres            <strong id="s-chars">‚Äî</strong></div>
    <div class="stats-row">Bytes                 <strong id="s-bytes">‚Äî</strong></div>
    <div class="stats-row">L√≠neas                <strong id="s-lines">‚Äî</strong></div>
    <div class="stats-row">Vel. promedio         <strong id="s-wpm-avg">‚Äî</strong></div>
    <div class="stats-row">Vel. pico             <strong id="s-wpm-peak">‚Äî</strong></div>
    <div class="stats-row">Inicio                <strong id="s-start">‚Äî</strong></div>
    <div class="stats-row">Fin                   <strong id="s-end">‚Äî</strong></div>
    <div class="stats-actions">
      <button class="btn" id="stats-export">EXPORTAR RESUMEN</button>
      <button class="btn" id="stats-close">CERRAR</button>
    </div>
  </div>
</div>

<!-- KEYS PANEL -->
<div id="keys-panel">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
    <div class="keys-title" style="margin-bottom:0;">ATAJOS</div>
    <button id="btn-keys-close" style="background:none;border:none;color:var(--fg-dim);font-family:var(--ui-font);font-size:18px;cursor:pointer;line-height:1;padding:0 2px;">√ó</button>
  </div>
  <div class="key-row"><span>Invertir colores</span>        <kbd>Ctrl+I</kbd></div>
  <div class="key-row"><span>Copiar todo</span>             <kbd>Ctrl+Shift+C</kbd></div>
  <div class="key-row"><span>Exportar .txt</span>           <kbd>Ctrl+S</kbd></div>
  <div class="key-row"><span>Borrar todo</span>             <kbd>Ctrl+Shift+X</kbd></div>
  <div class="key-row"><span>Timer</span>                   <kbd>Ctrl+Shift+T</kbd></div>
  <div class="key-row"><span>Sprint</span>                  <kbd>Ctrl+Shift+P</kbd></div>
  <div class="key-row"><span>Guardar en Drive</span>        <kbd>Ctrl+Shift+D</kbd></div>
  <div class="key-row"><span>Pomodoro</span>                <kbd>Ctrl+Shift+O</kbd></div>
  <div class="key-row"><span>Sesi√≥n</span>                  <kbd>Ctrl+Shift+E</kbd></div>
  <div class="key-row"><span>Panel atajos</span>            <kbd>Ctrl+Shift+H</kbd></div>
  <div class="key-row"><span>Finalizar sesi√≥n</span>        <kbd>escribir "finalizar"</kbd></div>
  <br>
  <div class="key-row" style="font-size:9px;color:var(--fg-dimmer);">*Solo funciona con sesi√≥n activa</div>
</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- TIMER -->
<div class="modal-wrap" id="modal-timer">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-timer">√ó</button>
    <div class="modal-title">TIMER DE ESCRITURA</div>
    <div class="modal-row">
      <div class="modal-label">MINUTOS</div>
      <input type="number" class="modal-input" id="timer-min" value="20" min="0" max="999">
    </div>
    <div class="modal-row">
      <div class="modal-label">SEGUNDOS</div>
      <input type="number" class="modal-input" id="timer-sec" value="0" min="0" max="59">
    </div>
    <div class="modal-row">
      <div class="modal-label">AL EXPIRAR</div>
      <select class="modal-input" id="timer-expire">
        <option value="freeze">Congelar escritura</option>
        <option value="panic">Borrar todo (modo p√°nico)</option>
        <option value="notify">Solo notificar</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-timer">CANCELAR</button>
      <button class="btn active" id="timer-start-btn">INICIAR TIMER</button>
    </div>
  </div>
</div>

<!-- SPRINT -->
<div class="modal-wrap" id="modal-sprint">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-sprint">√ó</button>
    <div class="modal-title">SPRINT DE ESCRITURA</div>
    <div class="modal-row">
      <div class="modal-label">META DE PALABRAS</div>
      <input type="number" class="modal-input" id="sprint-goal" value="500" min="1" max="99999">
    </div>
    <div class="modal-row">
      <div class="modal-label">AL ALCANZAR LA META</div>
      <select class="modal-input" id="sprint-expire">
        <option value="continue">Seguir escribiendo (solo notificar)</option>
        <option value="freeze">Congelar escritura</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-sprint">CANCELAR</button>
      <button class="btn active" id="sprint-start-btn">INICIAR SPRINT</button>
    </div>
  </div>
</div>

<!-- EXPORT ENCRYPTED -->
<div class="modal-wrap" id="modal-export-enc">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-export-enc">√ó</button>
    <div class="modal-title">EXPORTAR ENCRIPTADO</div>
    <div class="modal-row">
      <div class="modal-label">CONTRASE√ëA (m√≠nimo 8 caracteres)</div>
      <input type="password" class="modal-input" id="enc-pass">
    </div>
    <div class="modal-row">
      <div class="modal-label">CONFIRMAR CONTRASE√ëA</div>
      <input type="password" class="modal-input" id="enc-pass2">
    </div>
    <div class="modal-row">
      <div class="modal-label">INCLUIR FIRMA CRIPTOGR√ÅFICA</div>
      <select class="modal-input" id="enc-include-sig">
        <option value="yes">S√≠ ‚Äî a√±adir hash SHA-256 + timestamp</option>
        <option value="no">No</option>
      </select>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-export-enc">CANCELAR</button>
      <button class="btn active" id="enc-export-btn">ENCRIPTAR Y DESCARGAR</button>
    </div>
  </div>
</div>

<!-- IMPORT -->
<div class="modal-wrap" id="modal-import">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-import">√ó</button>
    <div class="modal-title">IMPORTAR ARCHIVO</div>
    <div class="modal-row">
      <div class="modal-label">ARCHIVO (.txt / .cryptpad)</div>
      <input type="file" class="modal-input" id="import-file" accept=".txt,.cryptpad,.enc">
    </div>
    <div id="import-pass-wrap" style="display:none;">
      <div class="modal-row">
        <div class="modal-label">CONTRASE√ëA</div>
        <input type="password" class="modal-input" id="import-pass">
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-import">CANCELAR</button>
      <button class="btn active" id="import-btn">IMPORTAR</button>
    </div>
  </div>
</div>

<!-- POMODORO -->
<div class="modal-wrap" id="modal-pomo">
  <div class="modal-backdrop"></div>
  <div class="modal-box" style="width:440px;">
    <button class="modal-close-x" data-close="modal-pomo">√ó</button>
    <div class="modal-title">POMODORO</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0 20px;">
      <div class="modal-row">
        <div class="modal-label">DURACI√ìN DE TRABAJO (min)</div>
        <input type="number" class="modal-input" id="pomo-work" value="25" min="1" max="120">
      </div>
      <div class="modal-row">
        <div class="modal-label">DESCANSO CORTO (min)</div>
        <input type="number" class="modal-input" id="pomo-short" value="5" min="1" max="60">
      </div>
      <div class="modal-row">
        <div class="modal-label">DESCANSO LARGO (min)</div>
        <input type="number" class="modal-input" id="pomo-long" value="15" min="1" max="120">
      </div>
      <div class="modal-row">
        <div class="modal-label">POMODOROS ANTES DEL DESCANSO LARGO</div>
        <input type="number" class="modal-input" id="pomo-before-long" value="4" min="1" max="20">
      </div>
      <div class="modal-row">
        <div class="modal-label">N√öMERO TOTAL DE CICLOS (0 = infinito)</div>
        <input type="number" class="modal-input" id="pomo-cycles" value="0" min="0" max="99">
      </div>
      <div class="modal-row">
        <div class="modal-label">CONGELAR ESCRITURA EN DESCANSOS</div>
        <select class="modal-input" id="pomo-freeze-break">
          <option value="yes">S√≠</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-pomo">CANCELAR</button>
      <button class="btn active" id="pomo-start-btn">INICIAR POMODORO</button>
    </div>
  </div>
</div>

<!-- DRIVE FILE PICKER -->
<div class="modal-wrap" id="modal-drive-open">
  <div class="modal-backdrop"></div>
  <div class="modal-box" style="width:460px;">
    <button class="modal-close-x" data-close="modal-drive-open">√ó</button>
    <div class="modal-title">ABRIR DESDE DRIVE</div>
    <div id="drive-file-list" style="min-height:80px; max-height:320px; overflow-y:auto; margin-bottom:4px;">
      <div style="font-size:12px; color:var(--fg-dim); padding:20px 0; text-align:center;">Cargando archivos‚Ä¶</div>
    </div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-drive-open">CANCELAR</button>
    </div>
  </div>
</div>

<!-- DRIVE SAVE NAME -->
<div class="modal-wrap" id="modal-drive-save">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <button class="modal-close-x" data-close="modal-drive-save">√ó</button>
    <div class="modal-title">GUARDAR EN DRIVE</div>
    <div class="modal-row">
      <div class="modal-label">NOMBRE DEL ARCHIVO</div>
      <input type="text" class="modal-input" id="drive-save-name" placeholder="nota-sin-titulo">
    </div>
    <div id="drive-save-info" style="font-size:11px; color:var(--fg-dim); margin-top:-6px; margin-bottom:10px;"></div>
    <div class="modal-actions">
      <button class="btn" data-close="modal-drive-save">CANCELAR</button>
      <button class="btn active" id="drive-save-confirm">GUARDAR</button>
    </div>
  </div>
</div>

<!-- CLEAR CONFIRM -->
<div class="modal-wrap" id="modal-clear">
  <div class="modal-backdrop"></div>
  <div class="modal-box">
    <div class="modal-title">BORRAR TODO EL CONTENIDO</div>
    <p style="font-size:12px;color:var(--fg-dim);line-height:1.75;margin-bottom:20px;">
      Esta acci√≥n es irreversible. El texto desaparecer√° permanentemente de la memoria del navegador.
    </p>
    <div class="modal-actions">
      <button class="btn" data-close="modal-clear">CANCELAR</button>
      <button class="btn active" id="clear-confirm-btn" style="border-color:#cc3333;background:#cc3333;color:#fff;">BORRAR DEFINITIVAMENTE</button>
    </div>
  </div>
</div>

<!-- NUKE CONFIRM -->
<div class="modal-wrap" id="modal-nuke">
  <div class="modal-backdrop"></div>
  <div class="modal-box" style="text-align:center;">
    <div style="font-size:40px; margin-bottom:16px; line-height:1;">üî•</div>
    <div class="modal-title" style="justify-content:center;">NUKEAR TODO</div>
    <p style="font-size:12px;color:var(--fg-dim);line-height:1.8;margin-bottom:22px;">
      Esto borrar√° todo el texto, desconectar√° Drive,<br>
      reiniciar√° todos los timers y recargar√° la p√°gina.<br>
      No quedar√° nada.
    </p>
    <div class="modal-actions" style="justify-content:center;">
      <button class="btn" data-close="modal-nuke">CANCELAR</button>
      <button class="btn" id="nuke-confirm-btn" style="border-color:#cc3333;background:#cc3333;color:#fff;">üî• NUKEAR</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  n0t3.xyz ‚Äî ephemeral encrypted notepad
//  no localStorage ¬∑ no cookies ¬∑ RAM only
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const $  = id => document.getElementById(id);
const editor = $('editor');

// ‚îÄ‚îÄ state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const S = {
  inverted:   false,
  typewriter: false,
  keysOpen:   false,
  // timer
  timerActive:    false,
  timerRemaining: 0,
  timerInterval:  null,
  timerExpire:    'freeze',
  // session
  sessionActive:   false,
  sessionStart:    null,
  sessionInterval: null,
  sessionElapsed:  0,
  sessionPeakWPM:  0,
  sessionStartWords: 0,
  // sprint
  sprintActive: false,
  sprintGoal:   0,
  sprintBase:   0,
  sprintExpire: 'continue',
  // wpm sliding window
  wpmWindow:  [],
  wpmTick:    null,
};

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function words(t)      { return t.trim() === '' ? 0 : t.trim().split(/\s+/).length; }
function bytes(t)      { return new TextEncoder().encode(t).length; }
function pad2(n)       { return String(n).padStart(2,'0'); }
function fmtDur(sec) {
  const h = Math.floor(sec/3600), m = Math.floor((sec%3600)/60), s = sec%60;
  if (h) return `${h}h ${m}m ${s}s`;
  if (m) return `${m}m ${s}s`;
  return `${s}s`;
}
function fmtClock(sec) {
  return `${pad2(Math.floor(sec/3600))}:${pad2(Math.floor((sec%3600)/60))}:${pad2(sec%60)}`;
}
function nowFilename() {
  const d = new Date();
  return `${d.getFullYear()}${pad2(d.getMonth()+1)}${pad2(d.getDate())}-${pad2(d.getHours())}${pad2(d.getMinutes())}`;
}

let notifTimer;
function notify(msg, dur=2800) {
  const n=$('notif'); n.textContent=msg; n.classList.add('show');
  clearTimeout(notifTimer);
  notifTimer = setTimeout(()=>n.classList.remove('show'), dur);
}

function openModal(id)  { $(id).classList.add('open'); }
function closeModal(id) { $(id).classList.remove('open'); }

document.querySelectorAll('[data-close]').forEach(b =>
  b.addEventListener('click', ()=> closeModal(b.dataset.close))
);
document.querySelectorAll('.modal-backdrop').forEach(bd =>
  bd.addEventListener('click', ()=> {
    const m = bd.closest('.modal-wrap'); if(m) closeModal(m.id);
  })
);

// ‚îÄ‚îÄ counters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCounters() {
  const t  = editor.value;
  const w  = words(t);
  $('cnt-words').textContent    = w.toLocaleString();
  $('cnt-chars').textContent    = t.length.toLocaleString();
  $('cnt-chars-ns').textContent = t.replace(/\s/g,'').length.toLocaleString();
  $('cnt-lines').textContent    = (t===''?1:t.split('\n').length).toLocaleString();
  $('cnt-paragraphs').textContent = (t===''?0:t.split(/\n\s*\n/).filter(p=>p.trim()).length).toLocaleString();
  $('cnt-bytes').textContent    = bytes(t).toLocaleString();
  $('cnt-readtime').textContent = w===0?'0 min':Math.ceil(w/200)+' min';

  if (S.sessionActive) S.wpmWindow.push({t:Date.now(), w});

  // sprint progress
  if (S.sprintActive) {
    const gained   = Math.max(0, w - S.sprintBase);
    const progress = Math.min(gained / S.sprintGoal, 1);
    $('sprint-bar').style.width = (progress*100)+'%';
    if (progress >= 1) completeSprint();
  }

  // finalizar keyword
  if (S.sessionActive && editor.value.trimEnd().endsWith('finalizar')) endSession();
}

// ‚îÄ‚îÄ WPM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
S.wpmTick = setInterval(()=>{
  const now = Date.now();
  S.wpmWindow = S.wpmWindow.filter(p => now-p.t < 30000);
  if (S.wpmWindow.length >= 2) {
    const f=S.wpmWindow[0], l=S.wpmWindow[S.wpmWindow.length-1];
    const dm = (l.t-f.t)/60000;
    const wpm = dm>0 ? Math.round(Math.max(0,l.w-f.w)/dm) : 0;
    $('cnt-wpm').textContent = wpm+' wpm';
    if (S.sessionActive && wpm>S.sessionPeakWPM) S.sessionPeakWPM=wpm;
  } else {
    $('cnt-wpm').textContent = '‚Äî wpm';
  }
}, 4000);

// ‚îÄ‚îÄ RULER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ruler      = $('ruler');
const handleL    = $('handle-left');
const handleR    = $('handle-right');
const shadeL     = $('ruler-shade-left');
const shadeR     = $('ruler-shade-right');
const tooltip    = $('ruler-tooltip');
const canvas     = $('ruler-ticks');
const ctx        = canvas.getContext('2d');

let marginLeft  = 120;
let marginRight = 120;

function applyMargins() {
  $('page').style.marginLeft  = marginLeft  + 'px';
  $('page').style.marginRight = marginRight + 'px';
  const W = ruler.offsetWidth;
  handleL.style.left  = marginLeft  + 'px';
  handleR.style.left  = (W - marginRight) + 'px';
  shadeL.style.width  = marginLeft  + 'px';
  shadeR.style.width  = marginRight + 'px';
  drawTicks();
}

function drawTicks() {
  const W = ruler.offsetWidth;
  const H = ruler.offsetHeight;
  canvas.width  = W;
  canvas.height = H;
  ctx.clearRect(0, 0, W, H);
  ctx.strokeStyle = getComputedStyle(document.documentElement)
    .getPropertyValue('--fg-dimmer').trim() || '#cccccc';
  ctx.lineWidth = 1;
  // tick every 10px, longer every 50px
  for (let x = 0; x <= W; x += 10) {
    const isMajor = x % 50 === 0;
    const tickH   = isMajor ? 10 : 5;
    ctx.beginPath();
    ctx.moveTo(x + 0.5, H);
    ctx.lineTo(x + 0.5, H - tickH);
    ctx.stroke();
  }
}

function showTooltip(x, val) {
  tooltip.textContent = val + ' px';
  tooltip.style.left  = x + 'px';
  tooltip.classList.add('show');
}
function hideTooltip() { tooltip.classList.remove('show'); }

function makeDraggable(handle, side) {
  let startX, startMargin;

  handle.addEventListener('mousedown', e => {
    e.preventDefault();
    startX      = e.clientX;
    startMargin = side === 'left' ? marginLeft : marginRight;
    handle.classList.add('dragging');

    function onMove(e) {
      const W    = ruler.offsetWidth;
      const dx   = side === 'left' ? e.clientX - startX : startX - e.clientX;
      const newM = Math.max(0, Math.min(W * 0.7, startMargin + dx));
      if (side === 'left') {
        marginLeft  = Math.round(newM);
        // don't let handles overlap
        if (marginLeft + marginRight > W * 0.85) marginLeft = Math.round(W * 0.85 - marginRight);
      } else {
        marginRight = Math.round(newM);
        if (marginLeft + marginRight > W * 0.85) marginRight = Math.round(W * 0.85 - marginLeft);
      }
      applyMargins();
      showTooltip(
        side === 'left' ? marginLeft : W - marginRight,
        side === 'left' ? marginLeft : marginRight
      );
    }

    function onUp() {
      handle.classList.remove('dragging');
      hideTooltip();
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup',   onUp);
    }

    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup',   onUp);
  });

  // touch support
  handle.addEventListener('touchstart', e => {
    e.preventDefault();
    startX      = e.touches[0].clientX;
    startMargin = side === 'left' ? marginLeft : marginRight;
    handle.classList.add('dragging');

    function onMove(e) {
      const W  = ruler.offsetWidth;
      const dx = side === 'left'
        ? e.touches[0].clientX - startX
        : startX - e.touches[0].clientX;
      const newM = Math.max(0, Math.min(W * 0.7, startMargin + dx));
      if (side === 'left') marginLeft  = Math.round(newM);
      else                 marginRight = Math.round(newM);
      applyMargins();
      showTooltip(
        side === 'left' ? marginLeft : W - marginRight,
        side === 'left' ? marginLeft : marginRight
      );
    }
    function onEnd() {
      handle.classList.remove('dragging');
      hideTooltip();
      handle.removeEventListener('touchmove', onMove);
      handle.removeEventListener('touchend',  onEnd);
    }
    handle.addEventListener('touchmove', onMove, { passive: false });
    handle.addEventListener('touchend',  onEnd);
  }, { passive: false });
}

makeDraggable(handleL, 'left');
makeDraggable(handleR, 'right');

// init ruler after layout
window.addEventListener('resize', applyMargins);

// ‚îÄ‚îÄ invert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleInvert() {
  S.inverted = !S.inverted;
  document.body.classList.toggle('inverted', S.inverted);
  $('btn-invert').classList.toggle('active', S.inverted);
  setTimeout(drawTicks, 50);
}
$('btn-invert').addEventListener('click', toggleInvert);

// ‚îÄ‚îÄ POMODORO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const P = {
  active:      false,
  paused:      false,
  phase:       'work',   // 'work' | 'short' | 'long'
  currentCycle: 0,       // completed work cycles
  pomoCurrent:  0,       // work cycles since last long break
  remaining:    0,
  total:        0,
  interval:     null,
  // config
  work:         25,
  short:        5,
  long:         15,
  beforeLong:   4,
  cycles:       0,       // 0 = infinite
  freezeBreak:  true,
};

$('btn-pomo').addEventListener('click', ()=>{
  if (P.active) { stopPomo(); return; }
  openModal('modal-pomo');
});

$('pomo-start-btn').addEventListener('click', ()=>{
  P.work        = parseInt($('pomo-work').value)        || 25;
  P.short       = parseInt($('pomo-short').value)       || 5;
  P.long        = parseInt($('pomo-long').value)        || 15;
  P.beforeLong  = parseInt($('pomo-before-long').value) || 4;
  P.cycles      = parseInt($('pomo-cycles').value)      || 0;
  P.freezeBreak = $('pomo-freeze-break').value === 'yes';
  closeModal('modal-pomo');
  startPomo();
});

function startPomo() {
  P.active       = true;
  P.paused       = false;
  P.phase        = 'work';
  P.currentCycle = 0;
  P.pomoCurrent  = 0;
  buildPomoDots();
  beginPhase('work');
  $('pomo-bar-wrap').classList.add('visible');
  $('btn-pomo').classList.add('active');
  $('btn-pomo').textContent = 'DETENER POMO';
  editor.disabled = false;
}

function beginPhase(phase) {
  P.phase = phase;
  clearInterval(P.interval);

  if (phase === 'work') {
    P.total     = P.work * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = `TRABAJO ${P.currentCycle + 1}${P.cycles ? '/'+P.cycles : ''}`;
    $('pomo-phase').className   = 'work';
    editor.disabled             = false;
    notify(`POMODORO ‚Äî trabajo ${P.currentCycle + 1}${P.cycles ? ' de '+P.cycles : ''} iniciado`);
  } else if (phase === 'short') {
    P.total     = P.short * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = 'DESCANSO CORTO';
    $('pomo-phase').className   = 'break';
    if (P.freezeBreak) editor.disabled = true;
    notify('DESCANSO CORTO ‚Äî descansa un momento');
  } else {
    P.total     = P.long * 60;
    P.remaining = P.total;
    $('pomo-phase').textContent = 'DESCANSO LARGO';
    $('pomo-phase').className   = 'break';
    if (P.freezeBreak) editor.disabled = true;
    notify('DESCANSO LARGO ‚Äî buen trabajo');
  }

  updatePomoDisplay();
  P.interval = setInterval(tickPomo, 1000);
}

function tickPomo() {
  if (P.paused) return;
  P.remaining--;
  updatePomoDisplay();
  if (P.remaining <= 0) {
    clearInterval(P.interval);
    onPomoPhaseEnd();
  }
}

function onPomoPhaseEnd() {
  if (P.phase === 'work') {
    P.currentCycle++;
    P.pomoCurrent++;
    markDot(P.currentCycle - 1);

    // check total cycles limit
    if (P.cycles > 0 && P.currentCycle >= P.cycles) {
      stopPomo(true);
      return;
    }

    // decide next break
    if (P.pomoCurrent >= P.beforeLong) {
      P.pomoCurrent = 0;
      beginPhase('long');
    } else {
      beginPhase('short');
    }
  } else {
    // break ended ‚Üí next work
    buildPomoDots();
    beginPhase('work');
  }
}

function updatePomoDisplay() {
  const m = Math.floor(P.remaining / 60);
  const s = P.remaining % 60;
  $('pomo-clock').textContent = pad2(m) + ':' + pad2(s);
  const pct = P.total > 0 ? ((P.total - P.remaining) / P.total * 100) : 0;
  $('pomo-track-fill').style.width = pct + '%';
}

function buildPomoDots() {
  const container = $('pomo-dots');
  container.innerHTML = '';
  const total = P.cycles > 0 ? P.cycles : P.beforeLong;
  for (let i = 0; i < total; i++) {
    const d = document.createElement('div');
    d.className = 'pomo-dot';
    if (i < P.currentCycle) d.classList.add('done');
    if (i === P.currentCycle) d.classList.add('active');
    container.appendChild(d);
  }
}

function markDot(idx) {
  const dots = $('pomo-dots').querySelectorAll('.pomo-dot');
  if (dots[idx]) {
    dots[idx].classList.remove('active');
    dots[idx].classList.add('done');
  }
  if (dots[idx + 1]) dots[idx + 1].classList.add('active');
}

function stopPomo(completed = false) {
  clearInterval(P.interval);
  P.active  = false;
  P.paused  = false;
  editor.disabled = false;
  $('pomo-bar-wrap').classList.remove('visible');
  $('btn-pomo').classList.remove('active');
  $('btn-pomo').textContent = 'POMODORO';
  $('pomo-track-fill').style.width = '0%';
  if (completed) notify(`POMODORO COMPLETADO ‚Äî ${P.currentCycle} ciclos finalizados`, 5000);
  else           notify('POMODORO DETENIDO');
}

$('pomo-pause-btn').addEventListener('click', ()=>{
  if (!P.active) return;
  P.paused = !P.paused;
  $('pomo-pause-btn').textContent = P.paused ? 'REANUDAR' : 'PAUSAR';
  $('pomo-pause-btn').classList.toggle('active', P.paused);
  if (P.paused && P.freezeBreak && P.phase !== 'work') {
    // already frozen, fine
  }
  if (!P.paused && P.phase !== 'work' && P.freezeBreak) {
    editor.disabled = true;
  }
  if (!P.paused && P.phase === 'work') {
    editor.disabled = false;
  }
});

$('pomo-skip-btn').addEventListener('click', ()=>{
  if (!P.active) return;
  clearInterval(P.interval);
  onPomoPhaseEnd();
});

$('pomo-stop-btn').addEventListener('click', ()=> stopPomo());

// ‚îÄ‚îÄ size switcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SIZES = {
  s: { size: '15px', lh: '1.8'  },
  m: { size: '18px', lh: '1.85' },
  l: { size: '22px', lh: '1.9'  },
};
// per-font base sizes for scaling
const FONT_BASE_SIZES = {
  fira:    { s: '15px', m: '18px', l: '22px' },
  lora:    { s: '17px', m: '20px', l: '24px' },
  nunito:  { s: '16px', m: '19px', l: '23px' },
  syne:    { s: '14px', m: '17px', l: '21px' },
  archivo: { s: '15px', m: '18px', l: '22px' },
};
let currentFontKey = 'fira';
let currentSizeKey = 's';

$('size-select').addEventListener('change', function() {
  currentSizeKey = this.value;
  applyFontAndSize();
});

function applyFontAndSize() {
  const f = FONTS[currentFontKey];
  const sz = FONT_BASE_SIZES[currentFontKey][currentSizeKey];
  const lh = SIZES[currentSizeKey].lh;
  document.documentElement.style.setProperty('--editor-font', f.family);
  document.documentElement.style.setProperty('--font-size',   sz);
  document.documentElement.style.setProperty('--line-height', lh);
}

// ‚îÄ‚îÄ font switcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FONTS = {
  fira:    { family: "'Fira Code', monospace",  size: '15px', lh: '1.8'  },
  lora:    { family: "'Lora', serif",            size: '17px', lh: '1.9'  },
  nunito:  { family: "'Nunito', sans-serif",     size: '16px', lh: '1.85' },
  syne:    { family: "'Syne Mono', monospace",   size: '14px', lh: '1.8'  },
  archivo: { family: "'Archivo', sans-serif",    size: '15px', lh: '1.75' },
};
$('font-select').addEventListener('change', function() {
  currentFontKey = this.value;
  applyFontAndSize();
});

// ‚îÄ‚îÄ typewriter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleTypewriter() {
  S.typewriter = !S.typewriter;
  $('btn-typewriter').classList.toggle('active', S.typewriter);
  document.body.classList.toggle('typewriter', S.typewriter);
  if (S.typewriter) editor.addEventListener('input', scrollTypewriter);
  else              editor.removeEventListener('input', scrollTypewriter);
}
function scrollTypewriter() {
  const cur = editor.selectionStart;
  const lineN = editor.value.substring(0,cur).split('\n').length;
  const wrap  = $('editor-wrap');
  wrap.scrollTop = Math.max(0, lineN*26 - wrap.clientHeight/2);
}
// ‚îÄ‚îÄ CLEAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-clear').addEventListener('click', ()=>openModal('modal-clear'));
$('clear-confirm-btn').addEventListener('click', ()=>{
  editor.value=''; updateCounters(); closeModal('modal-clear'); notify('CONTENIDO BORRADO');
});

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-timer').addEventListener('click', ()=>{
  if (S.timerActive) { stopTimer(); return; }
  openModal('modal-timer');
});
$('timer-start-btn').addEventListener('click', ()=>{
  const min = parseInt($('timer-min').value)||0;
  const sec = parseInt($('timer-sec').value)||0;
  const total = min*60+sec;
  if (total<=0) return notify('TIEMPO INV√ÅLIDO');
  S.timerExpire = $('timer-expire').value;
  closeModal('modal-timer');
  startTimer(total);
});

function startTimer(seconds) {
  clearInterval(S.timerInterval);
  S.timerActive    = true;
  S.timerRemaining = seconds;
  editor.disabled  = false;
  $('btn-timer').classList.add('active');
  $('btn-timer').textContent = 'DETENER TIMER';
  $('timer-overlay').classList.add('visible');
  $('timer-label').textContent = 'TIMER ACTIVO';
  renderTimerBig();
  S.timerInterval = setInterval(()=>{
    S.timerRemaining--;
    renderTimerBig();
    if (S.timerRemaining <= 0) {
      clearInterval(S.timerInterval);
      S.timerActive = false;
      onTimerExpire();
    }
  }, 1000);
}

function stopTimer() {
  clearInterval(S.timerInterval);
  S.timerActive = false;
  $('btn-timer').classList.remove('active');
  $('btn-timer').textContent = 'TIMER';
  $('timer-overlay').classList.remove('visible','warning','expired');
  editor.disabled = false;
  notify('TIMER DETENIDO');
}

function renderTimerBig() {
  const r  = S.timerRemaining;
  const m  = Math.floor(r/60);
  const s  = r%60;
  $('timer-big').textContent = pad2(m)+':'+pad2(s);
  const ov = $('timer-overlay');
  ov.classList.toggle('warning', r<=30 && r>0);
}

function onTimerExpire() {
  $('btn-timer').textContent = 'TIMER';
  $('btn-timer').classList.remove('active');
  $('timer-overlay').classList.remove('warning');
  $('timer-overlay').classList.add('expired');
  $('timer-big').textContent = '00:00';
  $('timer-label').textContent = 'TIEMPO AGOTADO';

  if (S.timerExpire==='freeze') {
    editor.disabled=true;
    notify('TIEMPO AGOTADO ‚Äî reinicia el timer para continuar', 4000);
  } else if (S.timerExpire==='panic') {
    editor.value=''; updateCounters();
    notify('TIEMPO AGOTADO ‚Äî CONTENIDO BORRADO', 4000);
    $('timer-overlay').classList.remove('visible','expired');
  } else {
    notify('TIEMPO AGOTADO', 3000);
  }
}

// ‚îÄ‚îÄ SESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-session').addEventListener('click', ()=>{
  if (S.sessionActive) endSession(); else startSession();
});

function startSession() {
  S.sessionActive    = true;
  S.sessionStart     = new Date();
  S.sessionElapsed   = 0;
  S.sessionPeakWPM   = 0;
  S.sessionStartWords= words(editor.value);
  S.wpmWindow        = [];
  $('btn-session').classList.add('active');
  $('btn-session').textContent = 'FINALIZAR SESI√ìN';
  const clock = $('session-clock');
  clock.classList.add('active');
  clock.textContent = '00:00:00';
  S.sessionInterval = setInterval(()=>{
    S.sessionElapsed++;
    clock.textContent = fmtClock(S.sessionElapsed);
  }, 1000);
  notify('SESI√ìN INICIADA ‚Äî escribe "finalizar" para terminar');
}

function endSession() {
  if (!S.sessionActive) return;
  clearInterval(S.sessionInterval);
  S.sessionActive = false;
  $('btn-session').classList.remove('active');
  $('btn-session').textContent = 'SESI√ìN';
  $('session-clock').classList.remove('active');

  const end  = new Date();
  const t    = editor.value;
  const w    = words(t);
  const gained  = Math.max(0, w - S.sessionStartWords);
  const totalMin= S.sessionElapsed/60;
  const avgWPM  = totalMin>0 ? Math.round(gained/totalMin) : 0;

  $('s-time').textContent     = fmtDur(S.sessionElapsed);
  $('s-words').textContent    = gained.toLocaleString();
  $('s-chars').textContent    = t.length.toLocaleString();
  $('s-bytes').textContent    = bytes(t).toLocaleString();
  $('s-lines').textContent    = (t===''?1:t.split('\n').length).toLocaleString();
  $('s-wpm-avg').textContent  = avgWPM+' wpm';
  $('s-wpm-peak').textContent = S.sessionPeakWPM+' wpm';
  $('s-start').textContent    = S.sessionStart.toLocaleTimeString();
  $('s-end').textContent      = end.toLocaleTimeString();

  $('stats-overlay').classList.add('open');

  if (editor.value.trimEnd().endsWith('finalizar')) {
    const idx = editor.value.lastIndexOf('finalizar');
    editor.value = editor.value.slice(0, idx);
    updateCounters();
  }
}

$('stats-close').addEventListener('click', ()=>$('stats-overlay').classList.remove('open'));
$('stats-export').addEventListener('click', ()=>{
  const lines = [
    'n0t3.xyz ‚Äî RESUMEN DE SESI√ìN',
    '‚îÄ'.repeat(36),
    'Inicio:           '+$('s-start').textContent,
    'Fin:              '+$('s-end').textContent,
    'Tiempo total:     '+$('s-time').textContent,
    'Palabras escritas:'+$('s-words').textContent,
    'Caracteres:       '+$('s-chars').textContent,
    'L√≠neas:           '+$('s-lines').textContent,
    'Bytes:            '+$('s-bytes').textContent,
    'Vel. promedio:    '+$('s-wpm-avg').textContent,
    'Vel. pico:        '+$('s-wpm-peak').textContent,
  ].join('\n');
  downloadText(lines, 'sesion-'+nowFilename()+'.txt');
  $('stats-overlay').classList.remove('open');
});

// ‚îÄ‚îÄ SPRINT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-sprint').addEventListener('click', ()=>{
  if (S.sprintFrozen) { resumeFromSprint(); return; }
  if (S.sprintActive) { endSprint(); return; }
  openModal('modal-sprint');
});

function resumeFromSprint() {
  S.sprintFrozen=false;
  editor.disabled=false;
  editor.focus();
  $('btn-sprint').classList.remove('active');
  $('btn-sprint').textContent='SPRINT';
  $('sprint-bar-wrap').style.display='none';
  $('sprint-bar').style.background='var(--fg)';
  notify('ESCRITURA REANUDADA');
}
$('sprint-start-btn').addEventListener('click', ()=>{
  const goal = parseInt($('sprint-goal').value);
  if (!goal||goal<1) return notify('META INV√ÅLIDA');
  S.sprintGoal   = goal;
  S.sprintBase   = words(editor.value);
  S.sprintExpire = $('sprint-expire').value;
  S.sprintActive = true;
  $('sprint-bar-wrap').style.display='block';
  $('sprint-bar').style.width='0%';
  $('btn-sprint').classList.add('active');
  $('btn-sprint').textContent = 'DETENER SPRINT';
  closeModal('modal-sprint');
  notify(`SPRINT: META ${goal} PALABRAS`);
});

function completeSprint() {
  S.sprintActive=false;
  $('sprint-bar').style.background='#22aa55';

  if (S.sprintExpire==='freeze') {
    editor.disabled=true;
    $('btn-sprint').classList.add('active');
    $('btn-sprint').textContent='REANUDAR ESCRITURA';
    // next click on btn-sprint will unfreeze
    S.sprintFrozen=true;
    notify('¬°SPRINT COMPLETADO! Pulsa REANUDAR ESCRITURA para continuar.', 5000);
  } else {
    $('btn-sprint').classList.remove('active');
    $('btn-sprint').textContent='SPRINT';
    notify('¬°SPRINT COMPLETADO! Puedes seguir escribiendo.', 4000);
    setTimeout(()=>{
      $('sprint-bar-wrap').style.display='none';
      $('sprint-bar').style.background='var(--fg)';
    }, 5000);
  }
}

function endSprint() {
  S.sprintActive=false;
  $('sprint-bar-wrap').style.display='none';
  $('btn-sprint').classList.remove('active');
  $('btn-sprint').textContent='SPRINT';
  editor.disabled=false;
  notify('SPRINT CANCELADO');
}

// ‚îÄ‚îÄ EXPORT .TXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-export').addEventListener('click', exportTxt);
async function exportTxt() {
  const t = editor.value;
  if (!t.trim()) return notify('NADA QUE EXPORTAR');
  const sig = await buildSignature(t);
  const out  = t + '\n\n' + sig;
  downloadText(out, 'nota-'+nowFilename()+'.txt');
}

// ‚îÄ‚îÄ EXPORT ENCRYPTED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-export-enc').addEventListener('click', ()=>openModal('modal-export-enc'));
$('enc-export-btn').addEventListener('click', async ()=>{
  const p1 = $('enc-pass').value;
  const p2 = $('enc-pass2').value;
  if (p1.length<8) return notify('CONTRASE√ëA MUY CORTA (m√≠nimo 8 caracteres)');
  if (p1!==p2)     return notify('LAS CONTRASE√ëAS NO COINCIDEN');
  const t = editor.value;
  if (!t.trim()) return notify('NADA QUE EXPORTAR');
  try {
    let payload = t;
    if ($('enc-include-sig').value==='yes') {
      payload = t + '\n\n' + await buildSignature(t);
    }
    const enc  = await encryptText(payload, p1);
    downloadText(enc, 'nota-'+nowFilename()+'.cryptpad');
    closeModal('modal-export-enc');
    $('enc-pass').value=''; $('enc-pass2').value='';
    notify('EXPORTADO Y ENCRIPTADO (AES-256-GCM)');
  } catch(e) { notify('ERROR AL ENCRIPTAR'); console.error(e); }
});

// ‚îÄ‚îÄ IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-import').addEventListener('click', ()=>openModal('modal-import'));
$('import-file').addEventListener('change', function(){
  const enc = this.files[0]?.name.match(/\.(cryptpad|enc)$/);
  $('import-pass-wrap').style.display = enc ? 'block' : 'none';
});
$('import-btn').addEventListener('click', async ()=>{
  const f = $('import-file').files[0];
  if (!f) return notify('SELECCIONA UN ARCHIVO');
  const isEnc = /\.(cryptpad|enc)$/.test(f.name);
  const reader = new FileReader();
  reader.onload = async e=>{
    let text = e.target.result;
    if (isEnc) {
      const pass = $('import-pass').value;
      if (!pass) return notify('INTRODUCE LA CONTRASE√ëA');
      try { text = await decryptText(text); }
      catch { return notify('ERROR: CONTRASE√ëA INCORRECTA O ARCHIVO DA√ëADO'); }
      // decryptText doesn't use pass yet ‚Äî fixed below
    }
    editor.value=text; updateCounters(); closeModal('modal-import'); notify('IMPORTADO');
  };
  reader.readAsText(f);
});

// ‚îÄ‚îÄ SHA-256 SIGNATURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sha256hex(text) {
  const buf  = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function buildSignature(text) {
  const ts   = new Date().toISOString();
  const hash = await sha256hex(text + '|' + ts);
  return [
    '‚îÄ'.repeat(60),
    'n0t3.xyz ¬∑ FIRMA CRIPTOGR√ÅFICA',
    'Timestamp : ' + ts,
    'SHA-256   : ' + hash,
    'Verificar : sha256( contenido_literal + "|" + timestamp )',
    '‚îÄ'.repeat(60),
  ].join('\n');
}

// ‚îÄ‚îÄ CRYPTO AES-256-GCM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function encryptText(plaintext, password) {
  const enc  = new TextEncoder();
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv   = crypto.getRandomValues(new Uint8Array(12));
  const km   = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key  = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
    km, {name:'AES-GCM',length:256}, false, ['encrypt']
  );
  const buf  = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plaintext));
  const combined = new Uint8Array(salt.length+iv.length+buf.byteLength);
  combined.set(salt,0); combined.set(iv,16); combined.set(new Uint8Array(buf),28);
  return 'N0T3ZT_V1:' + btoa(String.fromCharCode(...combined));
}

async function decryptText(ciphertext, password) {
  if (!ciphertext.startsWith('N0T3ZT_V1:') && !ciphertext.startsWith('CRYPTPAD_V1:'))
    throw new Error('Formato inv√°lido');
  const prefix = ciphertext.startsWith('N0T3ZT_V1:') ? 'N0T3ZT_V1:' : 'CRYPTPAD_V1:';
  const combined = Uint8Array.from(atob(ciphertext.slice(prefix.length)), c=>c.charCodeAt(0));
  const salt=combined.slice(0,16), iv=combined.slice(16,28), data=combined.slice(28);
  const enc = new TextEncoder();
  const km  = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:150000, hash:'SHA-256'},
    km, {name:'AES-GCM',length:256}, false, ['decrypt']
  );
  const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, data);
  return new TextDecoder().decode(plain);
}

// ‚îÄ‚îÄ DOWNLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function downloadText(text, filename) {
  const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
  notify('DESCARGADO: '+filename);
}

// ‚îÄ‚îÄ EDITOR EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
editor.addEventListener('input', updateCounters);

editor.addEventListener('select',  updateSelectionCounters);
editor.addEventListener('mouseup', updateSelectionCounters);
editor.addEventListener('keyup',   updateSelectionCounters);

function updateSelectionCounters() {
  const start = editor.selectionStart;
  const end   = editor.selectionEnd;
  if (start === end) {
    if ($('selection-badge').classList.contains('visible')) {
      $('selection-badge').classList.remove('visible');
      updateCounters();
    }
    return;
  }
  const sel = editor.value.slice(start, end);
  const w   = words(sel);
  $('selection-badge').classList.add('visible');
  $('cnt-words').textContent      = w.toLocaleString();
  $('cnt-chars').textContent      = sel.length.toLocaleString();
  $('cnt-chars-ns').textContent   = sel.replace(/\s/g,'').length.toLocaleString();
  $('cnt-lines').textContent      = sel.split('\n').length.toLocaleString();
  $('cnt-paragraphs').textContent = (sel.split(/\n\s*\n/).filter(p=>p.trim()).length||0).toLocaleString();
  $('cnt-bytes').textContent      = bytes(sel).toLocaleString();
  $('cnt-readtime').textContent   = w===0 ? '0 min' : Math.ceil(w/200)+' min';
}

editor.addEventListener('paste', e=>{
  e.preventDefault();
  const text=(e.clipboardData||window.clipboardData).getData('text/plain');
  document.execCommand('insertText', false, text);
});

// ‚îÄ‚îÄ KEYBOARD SHORTCUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e=>{
  const ctrl = e.ctrlKey||e.metaKey;
  if (ctrl && e.key==='i')                         { e.preventDefault(); toggleInvert(); }
  if (ctrl && e.key==='t')                         { e.preventDefault(); toggleTypewriter(); }
  if (ctrl && e.key==='s')                         { e.preventDefault(); exportTxt(); }
  if (ctrl && e.shiftKey && e.key==='C')           { e.preventDefault(); copyAll(); }
  if (ctrl && e.shiftKey && e.key==='X')           { e.preventDefault(); openModal('modal-clear'); }
  if (ctrl && e.shiftKey && e.key==='T')           { e.preventDefault(); openModal('modal-timer'); }
  if (ctrl && e.shiftKey && (e.key==='P'||e.key==='p')) { e.preventDefault(); openModal('modal-sprint'); }
  if (ctrl && e.shiftKey && (e.key==='D'||e.key==='d')) { e.preventDefault(); if(DRIVE.connected) $('btn-drive-save').click(); }
  if (ctrl && e.shiftKey && (e.key==='O'||e.key==='o')) { e.preventDefault(); P.active?stopPomo():openModal('modal-pomo'); }
  if (ctrl && e.shiftKey && (e.key==='E'||e.key==='e')) { e.preventDefault(); S.sessionActive?endSession():startSession(); }
  if (ctrl && e.shiftKey && (e.key==='H'||e.key==='h')) { e.preventDefault(); S.keysOpen=!S.keysOpen; $('keys-panel').classList.toggle('open',S.keysOpen); }
  if (e.key==='Escape') {
    document.querySelectorAll('.modal-wrap.open').forEach(m=>closeModal(m.id));
    $('stats-overlay').classList.remove('open');
    if (S.keysOpen) { closeKeysPanel(); }
  }
});

function copyAll() {
  if (!editor.value) return notify('NADA QUE COPIAR');
  navigator.clipboard.writeText(editor.value).then(()=>notify('COPIADO AL PORTAPAPELES'));
}

// ‚îÄ‚îÄ GOOGLE DRIVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DRIVE = {
  CLIENT_ID:   '520091872644-b1k8so4ins1to458dep2pc3ml73qif7j.apps.googleusercontent.com',
  SCOPE:       'https://www.googleapis.com/auth/drive.file',
  FOLDER_NAME: 'n0t3.xyz',
  connected:   false,
  token:       null,
  folderId:    null,
  currentFileId:   null,
  currentFileName: null,
};

// Load gapi client
function initGapiClient() {
  gapi.client.init({}).then(() => {
    // gapi ready ‚Äî token client handles auth separately
  });
}

let tokenClient;

function initDrive() {
  if (typeof google === 'undefined' || typeof gapi === 'undefined') {
    setTimeout(initDrive, 500);
    return;
  }
  gapi.load('client', initGapiClient);

  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: DRIVE.CLIENT_ID,
    scope:     DRIVE.SCOPE,
    callback:  async (response) => {
      if (response.error) { notify('ERROR DE AUTENTICACI√ìN: ' + response.error); return; }
      DRIVE.token     = response.access_token;
      DRIVE.connected = true;
      gapi.client.setToken({ access_token: DRIVE.token });
      $('btn-drive-connect').textContent = 'DRIVE ‚úì';
      $('btn-drive-connect').classList.add('active');
      // show dropdown items
      $('dmenu-save').style.display       = '';
      $('dmenu-open').style.display       = '';
      $('dmenu-disconnect').style.display = '';
      notify('CONECTADO A GOOGLE DRIVE');
      DRIVE.folderId = await ensureDriveFolder();
    },
  });
}

// btn-drive-connect is now handled by the Drive dropdown below

// ‚îÄ‚îÄ Ensure n0t3.xyz folder exists in Drive ‚îÄ‚îÄ
async function ensureDriveFolder() {
  const res = await driveRequest(
    `https://www.googleapis.com/drive/v3/files?q=name='${DRIVE.FOLDER_NAME}'+and+mimeType='application/vnd.google-apps.folder'+and+trashed=false&fields=files(id,name)`,
    'GET'
  );
  const data = await res.json();
  if (data.files && data.files.length > 0) return data.files[0].id;

  // Create folder
  const create = await driveRequest(
    'https://www.googleapis.com/drive/v3/files',
    'POST',
    { name: DRIVE.FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' }
  );
  const folder = await create.json();
  return folder.id;
}

// ‚îÄ‚îÄ Generic Drive fetch helper ‚îÄ‚îÄ
async function driveRequest(url, method='GET', body=null) {
  const opts = {
    method,
    headers: {
      'Authorization': 'Bearer ' + DRIVE.token,
      'Content-Type':  'application/json',
    },
  };
  if (body) opts.body = JSON.stringify(body);
  return fetch(url, opts);
}

// ‚îÄ‚îÄ Save to Drive ‚îÄ‚îÄ
$('btn-drive-save').addEventListener('click', () => {
  if (!DRIVE.connected) return notify('CONECTA DRIVE PRIMERO');
  if (!editor.value.trim()) return notify('NADA QUE GUARDAR');
  // Prefill with current filename or timestamp
  $('drive-save-name').value = DRIVE.currentFileName
    ? DRIVE.currentFileName.replace(/\.txt$/, '')
    : 'nota-' + nowFilename();
  const info = DRIVE.currentFileId
    ? `Actualizar√° el archivo existente: ${DRIVE.currentFileName}`
    : 'Se crear√° un archivo nuevo en la carpeta n0t3.xyz/ de tu Drive';
  $('drive-save-info').textContent = info;
  openModal('modal-drive-save');
});

$('drive-save-confirm').addEventListener('click', async () => {
  let name = ($('drive-save-name').value.trim() || 'nota') ;
  if (!name.endsWith('.txt')) name += '.txt';
  closeModal('modal-drive-save');
  notify('GUARDANDO EN DRIVE‚Ä¶');
  try {
    await saveToDrive(name);
    notify('GUARDADO: ' + name);
  } catch(e) {
    notify('ERROR AL GUARDAR EN DRIVE');
    console.error(e);
  }
});

async function saveToDrive(filename) {
  const content = editor.value;
  const sig     = await buildSignature(content);
  const full    = content + '\n\n' + sig;
  const blob    = new Blob([full], { type: 'text/plain' });

  if (DRIVE.currentFileId) {
    // Update existing file (PATCH)
    await fetch(
      `https://www.googleapis.com/upload/drive/v3/files/${DRIVE.currentFileId}?uploadType=media`,
      { method: 'PATCH', headers: { 'Authorization': 'Bearer ' + DRIVE.token, 'Content-Type': 'text/plain' }, body: blob }
    );
    // Rename if needed
    await driveRequest(
      `https://www.googleapis.com/drive/v3/files/${DRIVE.currentFileId}`,
      'PATCH', { name: filename }
    );
    DRIVE.currentFileName = filename;
  } else {
    // Create new file with multipart upload
    if (!DRIVE.folderId) DRIVE.folderId = await ensureDriveFolder();
    const meta     = JSON.stringify({ name: filename, parents: [DRIVE.folderId] });
    const boundary = 'n0t3xyz_boundary';
    const body     = `--${boundary}\r\nContent-Type: application/json\r\n\r\n${meta}\r\n--${boundary}\r\nContent-Type: text/plain\r\n\r\n${full}\r\n--${boundary}--`;
    const res = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name',
      { method: 'POST', headers: { 'Authorization': 'Bearer ' + DRIVE.token, 'Content-Type': `multipart/related; boundary=${boundary}` }, body }
    );
    const file = await res.json();
    DRIVE.currentFileId   = file.id;
    DRIVE.currentFileName = file.name;
  }
}

// ‚îÄ‚îÄ Open from Drive ‚îÄ‚îÄ
$('btn-drive-open').addEventListener('click', async () => {
  if (!DRIVE.connected) return notify('CONECTA DRIVE PRIMERO');
  openModal('modal-drive-open');
  $('drive-file-list').innerHTML = '<div style="font-size:12px;color:var(--fg-dim);padding:20px 0;text-align:center;">Cargando archivos‚Ä¶</div>';
  try {
    if (!DRIVE.folderId) DRIVE.folderId = await ensureDriveFolder();
    const res  = await driveRequest(
      `https://www.googleapis.com/drive/v3/files?q='${DRIVE.folderId}'+in+parents+and+mimeType='text/plain'+and+trashed=false&orderBy=modifiedTime+desc&fields=files(id,name,modifiedTime,size)&pageSize=50`,
      'GET'
    );
    const data = await res.json();
    if (!data.files || data.files.length === 0) {
      $('drive-file-list').innerHTML = '<div style="font-size:12px;color:var(--fg-dim);padding:20px 0;text-align:center;">No hay archivos en n0t3.xyz/</div>';
      return;
    }
    $('drive-file-list').innerHTML = data.files.map(f => {
      const date = new Date(f.modifiedTime).toLocaleString();
      const kb   = f.size ? (f.size / 1024).toFixed(1) + ' KB' : '';
      return `<div class="drive-file-row" data-id="${f.id}" data-name="${f.name}">
        <span class="drive-file-name">${f.name}</span>
        <span class="drive-file-meta">${date}${kb ? ' ¬∑ ' + kb : ''}</span>
      </div>`;
    }).join('');
    document.querySelectorAll('.drive-file-row').forEach(row => {
      row.addEventListener('click', () => loadFromDrive(row.dataset.id, row.dataset.name));
    });
  } catch(e) {
    $('drive-file-list').innerHTML = '<div style="font-size:12px;color:#cc3333;padding:20px 0;text-align:center;">Error al cargar archivos.</div>';
    console.error(e);
  }
});

async function loadFromDrive(fileId, fileName) {
  closeModal('modal-drive-open');
  notify('ABRIENDO ' + fileName + '‚Ä¶');
  try {
    const res  = await fetch(
      `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`,
      { headers: { 'Authorization': 'Bearer ' + DRIVE.token } }
    );
    const text = await res.text();
    editor.value = text;
    updateCounters();
    DRIVE.currentFileId   = fileId;
    DRIVE.currentFileName = fileName;
    notify('ABIERTO: ' + fileName);
  } catch(e) {
    notify('ERROR AL ABRIR ARCHIVO');
    console.error(e);
  }
}

// Init Drive after page load
window.addEventListener('load', initDrive);

// ‚îÄ‚îÄ TOOLS DROPDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const toolsMenu = $('tools-menu');
$('btn-tools').addEventListener('click', e => {
  e.stopPropagation();
  toolsMenu.classList.toggle('open');
});
document.addEventListener('click', () => toolsMenu.classList.remove('open'));
toolsMenu.addEventListener('click', e => e.stopPropagation());

// Wire menu items ‚Üí proxy buttons
$('tmenu-sprint').addEventListener('click',  () => { toolsMenu.classList.remove('open'); $('btn-sprint').click();  });
$('tmenu-timer').addEventListener('click',   () => { toolsMenu.classList.remove('open'); $('btn-timer').click();   });
$('tmenu-session').addEventListener('click', () => { toolsMenu.classList.remove('open'); $('btn-session').click(); });
$('tmenu-pomo').addEventListener('click',    () => { toolsMenu.classList.remove('open'); $('btn-pomo').click();    });

// Sync menu item labels with proxy button state
function syncToolLabels() {
  const pairs = [
    ['btn-sprint','tmenu-sprint','Sprint'],
    ['btn-timer','tmenu-timer','Timer'],
    ['btn-session','tmenu-session','Sesi√≥n'],
    ['btn-pomo','tmenu-pomo','Pomodoro'],
  ];
  pairs.forEach(([src, dst, def]) => {
    const srcEl = $(src), dstEl = $(dst);
    dstEl.textContent = srcEl.textContent.trim() || def;
    dstEl.classList.toggle('active', srcEl.classList.contains('active'));
  });
}
const proxyObserver = new MutationObserver(syncToolLabels);
['btn-sprint','btn-timer','btn-session','btn-pomo'].forEach(id =>
  proxyObserver.observe($(id), { attributes: true, childList: true, characterData: true, subtree: true })
);

// ‚îÄ‚îÄ TOPBAR HIDE / SHOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('topbar-toggle').addEventListener('click', () => {
  $('topbar').style.display = 'none';
  $('topbar-stub').classList.add('visible');
  setTimeout(applyMargins, 0);
});
$('topbar-show').addEventListener('click', () => {
  $('topbar').style.display = '';
  $('topbar-stub').classList.remove('visible');
  setTimeout(applyMargins, 0);
});

// ‚îÄ‚îÄ DRIVE DROPDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const driveMenu = $('drive-menu');
$('btn-drive-connect').addEventListener('click', e => {
  // If connected, toggle dropdown instead of disconnecting directly
  if (DRIVE.connected) {
    e.stopPropagation();
    driveMenu.classList.toggle('open');
    return;
  }
  // Not connected ‚Äî trigger auth
  if (typeof google === 'undefined') { notify('GOOGLE API A√öN CARGANDO‚Ä¶'); return; }
  tokenClient.requestAccessToken({ prompt: '' });
}, true); // capture phase so this runs before the old listener
driveMenu.addEventListener('click', e => e.stopPropagation());
document.addEventListener('click', () => driveMenu.classList.remove('open'));

$('dmenu-save').addEventListener('click', () => {
  driveMenu.classList.remove('open');
  $('btn-drive-save').click();
});
$('dmenu-open').addEventListener('click', () => {
  driveMenu.classList.remove('open');
  $('btn-drive-open').click();
});
$('dmenu-disconnect').addEventListener('click', () => {
  driveMenu.classList.remove('open');
  // Trigger the existing disconnect logic
  DRIVE.connected = true; // ensure disconnect branch runs
  $('btn-drive-connect').click();
});

// ‚îÄ‚îÄ NUKE üî• ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
$('btn-nuke').addEventListener('click', () => openModal('modal-nuke'));

$('nuke-confirm-btn').addEventListener('click', () => {
  // 1. Revoke Drive if connected
  if (DRIVE.connected && typeof google !== 'undefined') {
    try { google.accounts.oauth2.revoke(DRIVE.token, ()=>{}); } catch(e) {}
  }
  // 2. Clear editor
  editor.value = '';
  // 3. Stop all timers
  if (S.timerActive)   stopTimer();
  if (S.sessionActive) endSession();
  if (S.sprintActive)  endSprint();
  if (P.active)        stopPomo();
  // 4. Remove beforeunload guard so reload doesn't prompt
  window.onbeforeunload = null;
  // 5. Reload
  location.reload();
});

// ‚îÄ‚îÄ KEYS PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeKeysPanel() {
  S.keysOpen = false;
  $('keys-panel').classList.remove('open');
}
$('btn-keys').addEventListener('click', () => {
  S.keysOpen = !S.keysOpen;
  $('keys-panel').classList.toggle('open', S.keysOpen);
});
$('btn-keys-close').addEventListener('click', closeKeysPanel);

window.addEventListener('beforeunload', e=>{
  if (editor.value.trim().length>0) { e.preventDefault(); e.returnValue=''; }
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
updateCounters();
setTimeout(applyMargins, 0); // after layout
editor.focus();
</script>
</body>
</html>
